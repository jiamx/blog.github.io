<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录朴实无华且枯燥的生活"><title>数仓开发需要了解的5大SQL分析函数 | Jmx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '912b6cfc43243cd27aeb428f7dbf7823';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">数仓开发需要了解的5大SQL分析函数</h1><a id="logo" href="/.">Jmx's Blog</a><p class="description">Keep it Simple and Stupid!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-pied-piper-alt"> 关于</i></a><a href="/tags"><i class="fa fa-tags"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">数仓开发需要了解的5大SQL分析函数</h1><div class="post-meta">Nov 26, 2020<span> | </span><span class="category"><a href="/categories/数仓/">数仓</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.8k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 9</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><a id="more"></a>

<h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">analytic_function_name([argument_list])</span><br><span class="line">OVER (</span><br><span class="line">[PARTITION BY partition_expression,…]</span><br><span class="line">[ORDER BY sort_expression, … [ASC|DESC]])</span><br></pre></td></tr></table></figure>

<ul>
<li><code>analytic_function_name</code>: 函数名称 — 比如 <code>RANK()</code>, <code>SUM()</code>, <code>FIRST()</code>等等</li>
<li><code>partition_expression</code>: 分区列</li>
<li><code>sort_expression</code>: 排序列</li>
</ul>
<blockquote>
<p>公众号『大数据技术与数仓』，回复『资料』领取大数据资料包</p>
</blockquote>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`orders`</span> (</span><br><span class="line">    <span class="string">`order_num`</span> <span class="keyword">String</span> <span class="keyword">COMMENT</span> <span class="string">'订单号'</span>,</span><br><span class="line">    <span class="string">`order_amount`</span> <span class="built_in">DECIMAL</span> ( <span class="number">12</span>, <span class="number">2</span> ) <span class="keyword">COMMENT</span> <span class="string">'订单金额'</span>,</span><br><span class="line">    <span class="string">`advance_amount`</span> <span class="built_in">DECIMAL</span> ( <span class="number">12</span>, <span class="number">2</span> ) <span class="keyword">COMMENT</span> <span class="string">'预付款'</span>,</span><br><span class="line">    <span class="string">`order_date`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'订单日期'</span>,</span><br><span class="line">    <span class="string">`cust_code`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'客户'</span>,</span><br><span class="line">    <span class="string">`agent_code`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'代理商'</span> </span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200100'</span>, <span class="string">'1000.00'</span>, <span class="string">'600.00'</span>, <span class="string">'2020-08-01'</span>, <span class="string">'C00013'</span>, <span class="string">'A003'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200110'</span>, <span class="string">'3000.00'</span>, <span class="string">'500.00'</span>, <span class="string">'2020-04-15'</span>, <span class="string">'C00019'</span>, <span class="string">'A010'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200107'</span>, <span class="string">'4500.00'</span>, <span class="string">'900.00'</span>, <span class="string">'2020-08-30'</span>, <span class="string">'C00007'</span>, <span class="string">'A010'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200112'</span>, <span class="string">'2000.00'</span>, <span class="string">'400.00'</span>, <span class="string">'2020-05-30'</span>, <span class="string">'C00016'</span>, <span class="string">'A007'</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200113'</span>, <span class="string">'4000.00'</span>, <span class="string">'600.00'</span>, <span class="string">'2020-06-10'</span>, <span class="string">'C00022'</span>, <span class="string">'A002'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200102'</span>, <span class="string">'2000.00'</span>, <span class="string">'300.00'</span>, <span class="string">'2020-05-25'</span>, <span class="string">'C00012'</span>, <span class="string">'A012'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200114'</span>, <span class="string">'3500.00'</span>, <span class="string">'2000.00'</span>, <span class="string">'2020-08-15'</span>, <span class="string">'C00002'</span>,<span class="string">'A008'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200122'</span>, <span class="string">'2500.00'</span>, <span class="string">'400.00'</span>, <span class="string">'2020-09-16'</span>, <span class="string">'C00003'</span>, <span class="string">'A004'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200118'</span>, <span class="string">'500.00'</span>, <span class="string">'100.00'</span>, <span class="string">'2020-07-20'</span>, <span class="string">'C00023'</span>, <span class="string">'A006'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200119'</span>, <span class="string">'4000.00'</span>, <span class="string">'700.00'</span>, <span class="string">'2020-09-16'</span>, <span class="string">'C00007'</span>, <span class="string">'A010'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200121'</span>, <span class="string">'1500.00'</span>, <span class="string">'600.00'</span>, <span class="string">'2020-09-23'</span>, <span class="string">'C00008'</span>, <span class="string">'A004'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200130'</span>, <span class="string">'2500.00'</span>, <span class="string">'400.00'</span>, <span class="string">'2020-07-30'</span>, <span class="string">'C00025'</span>, <span class="string">'A011'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200134'</span>, <span class="string">'4200.00'</span>, <span class="string">'1800.00'</span>, <span class="string">'2020-09-25'</span>, <span class="string">'C00004'</span>,<span class="string">'A005'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200108'</span>, <span class="string">'4000.00'</span>, <span class="string">'600.00'</span>, <span class="string">'2020-02-15'</span>, <span class="string">'C00008'</span>, <span class="string">'A004'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200103'</span>, <span class="string">'1500.00'</span>, <span class="string">'700.00'</span>, <span class="string">'2020-05-15'</span>, <span class="string">'C00021'</span>, <span class="string">'A005'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200105'</span>, <span class="string">'2500.00'</span>, <span class="string">'500.00'</span>, <span class="string">'2020-07-18'</span>, <span class="string">'C00025'</span>, <span class="string">'A011'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200109'</span>, <span class="string">'3500.00'</span>, <span class="string">'800.00'</span>, <span class="string">'2020-07-30'</span>, <span class="string">'C00011'</span>, <span class="string">'A010'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200101'</span>, <span class="string">'3000.00'</span>, <span class="string">'1000.00'</span>, <span class="string">'2020-07-15'</span>, <span class="string">'C00001'</span>,<span class="string">'A008'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200111'</span>, <span class="string">'1000.00'</span>, <span class="string">'300.00'</span>, <span class="string">'2020-07-10'</span>, <span class="string">'C00020'</span>, <span class="string">'A008'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200104'</span>, <span class="string">'1500.00'</span>, <span class="string">'500.00'</span>, <span class="string">'2020-03-13'</span>, <span class="string">'C00006'</span>, <span class="string">'A004'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200106'</span>, <span class="string">'2500.00'</span>, <span class="string">'700.00'</span>, <span class="string">'2020-04-20'</span>, <span class="string">'C00005'</span>, <span class="string">'A002'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200125'</span>, <span class="string">'2000.00'</span>, <span class="string">'600.00'</span>, <span class="string">'2020-10-01'</span>, <span class="string">'C00018'</span>, <span class="string">'A005'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200117'</span>, <span class="string">'800.00'</span>, <span class="string">'200.00'</span>, <span class="string">'2020-10-20'</span>, <span class="string">'C00014'</span>, <span class="string">'A001'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200123'</span>, <span class="string">'500.00'</span>, <span class="string">'100.00'</span>, <span class="string">'2020-09-16'</span>, <span class="string">'C00022'</span>, <span class="string">'A002'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200120'</span>, <span class="string">'500.00'</span>, <span class="string">'100.00'</span>, <span class="string">'2020-07-20'</span>, <span class="string">'C00009'</span>, <span class="string">'A002'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200116'</span>, <span class="string">'500.00'</span>, <span class="string">'100.00'</span>, <span class="string">'2020-07-13'</span>, <span class="string">'C00010'</span>, <span class="string">'A009'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200124'</span>, <span class="string">'500.00'</span>, <span class="string">'100.00'</span>, <span class="string">'2020-06-20'</span>, <span class="string">'C00017'</span>, <span class="string">'A007'</span>); </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200126'</span>, <span class="string">'500.00'</span>, <span class="string">'100.00'</span>, <span class="string">'2020-06-24'</span>, <span class="string">'C00022'</span>, <span class="string">'A002'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200129'</span>, <span class="string">'2500.00'</span>, <span class="string">'500.00'</span>, <span class="string">'2020-07-20'</span>, <span class="string">'C00024'</span>, <span class="string">'A006'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200127'</span>, <span class="string">'2500.00'</span>, <span class="string">'400.00'</span>, <span class="string">'2020-07-20'</span>, <span class="string">'C00015'</span>, <span class="string">'A003'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200128'</span>, <span class="string">'3500.00'</span>, <span class="string">'1500.00'</span>, <span class="string">'2020-07-20'</span>, <span class="string">'C00009'</span>,<span class="string">'A002'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200135'</span>, <span class="string">'2000.00'</span>, <span class="string">'800.00'</span>, <span class="string">'2020-09-16'</span>, <span class="string">'C00007'</span>, <span class="string">'A010'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200131'</span>, <span class="string">'900.00'</span>, <span class="string">'150.00'</span>, <span class="string">'2020-08-26'</span>, <span class="string">'C00012'</span>, <span class="string">'A012'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> orders <span class="keyword">VALUES</span>(<span class="string">'200133'</span>, <span class="string">'1200.00'</span>, <span class="string">'400.00'</span>, <span class="string">'2020-06-29'</span>, <span class="string">'C00009'</span>, <span class="string">'A002'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="AVG-和SUM"><a href="#AVG-和SUM" class="headerlink" title="AVG() 和SUM()"></a>AVG() 和SUM()</h3><h4 id="需求描述："><a href="#需求描述：" class="headerlink" title="需求描述："></a>需求描述：</h4><p>第三季度每个代理商的移动平均收入和总收入</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    agent_code,</span><br><span class="line">    order_date,</span><br><span class="line">    <span class="keyword">AVG</span>( order_amount ) <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> agent_code <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date)  avg_rev,</span><br><span class="line">    <span class="keyword">SUM</span>( order_amount ) <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> agent_code <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date ) total_rev </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">orders </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">order_date &gt;= <span class="string">'2020-07-01'</span> </span><br><span class="line"><span class="keyword">AND</span> order_date &lt;= <span class="string">'2020-09-30'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="结果输出"><a href="#结果输出" class="headerlink" title="结果输出"></a>结果输出</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">A002    2020-07-20      2000    4000</span><br><span class="line">A002    2020-07-20      2000    4000</span><br><span class="line">A002    2020-09-16      1500    4500</span><br><span class="line">A003    2020-07-20      2500    2500</span><br><span class="line">A003    2020-08-01      1750    3500</span><br><span class="line">A004    2020-09-16      2500    2500</span><br><span class="line">A004    2020-09-23      2000    4000</span><br><span class="line">A005    2020-09-25      4200    4200</span><br><span class="line">A006    2020-07-20      1500    3000</span><br><span class="line">A006    2020-07-20      1500    3000</span><br><span class="line">A008    2020-07-10      1000    1000</span><br><span class="line">A008    2020-07-15      2000    4000</span><br><span class="line">A008    2020-08-15      2500    7500</span><br><span class="line">A009    2020-07-13      500     500</span><br><span class="line">A010    2020-07-30      3500    3500</span><br><span class="line">A010    2020-08-30      4000    8000</span><br><span class="line">A010    2020-09-16      3500    14000</span><br><span class="line">A010    2020-09-16      3500    14000</span><br><span class="line">A011    2020-07-18      2500    2500</span><br><span class="line">A011    2020-07-30      2500    5000</span><br><span class="line">A012    2020-08-26      900     900</span><br></pre></td></tr></table></figure>

<h3 id="FIRST-VALUE-和-LAST-VALUE"><a href="#FIRST-VALUE-和-LAST-VALUE" class="headerlink" title="FIRST_VALUE()和 LAST_VALUE()"></a>FIRST_VALUE()和 LAST_VALUE()</h3><ul>
<li>first_value: 取分组内排序后，截止到当前行，第一个值 </li>
<li>last_value: 取分组内排序后，截止到当前行，最后一个值 </li>
</ul>
<h4 id="需求描述"><a href="#需求描述" class="headerlink" title="需求描述"></a>需求描述</h4><p>客户首次购买后多少天才进行下一次购买</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    cust_code,</span><br><span class="line">    order_date,</span><br><span class="line">    <span class="keyword">datediff</span>(order_date,<span class="keyword">FIRST_VALUE</span> ( order_date ) <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> cust_code <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_date )) next_order_gap </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">orders </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> cust_code,next_order_gap</span><br></pre></td></tr></table></figure>

<h4 id="结果输出-1"><a href="#结果输出-1" class="headerlink" title="结果输出"></a>结果输出</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">C00001  2020-07-15      0</span><br><span class="line">C00002  2020-08-15      0</span><br><span class="line">C00003  2020-09-16      0</span><br><span class="line">C00004  2020-09-25      0</span><br><span class="line">C00005  2020-04-20      0</span><br><span class="line">C00006  2020-03-13      0</span><br><span class="line">C00007  2020-08-30      0</span><br><span class="line">C00007  2020-09-16      17</span><br><span class="line">C00007  2020-09-16      17</span><br><span class="line">C00008  2020-02-15      0</span><br><span class="line">C00008  2020-09-23      221</span><br><span class="line">C00009  2020-06-29      0</span><br><span class="line">C00009  2020-07-20      21</span><br><span class="line">C00009  2020-07-20      21</span><br><span class="line">C00010  2020-07-13      0</span><br><span class="line">C00011  2020-07-30      0</span><br><span class="line">C00012  2020-05-25      0</span><br><span class="line">C00012  2020-08-26      93</span><br><span class="line">C00013  2020-08-01      0</span><br><span class="line">C00014  2020-10-20      0</span><br><span class="line">C00015  2020-07-20      0</span><br><span class="line">C00016  2020-05-30      0</span><br><span class="line">C00017  2020-06-20      0</span><br><span class="line">C00018  2020-10-01      0</span><br><span class="line">C00019  2020-04-15      0</span><br><span class="line">C00020  2020-07-10      0</span><br><span class="line">C00021  2020-05-15      0</span><br><span class="line">C00022  2020-06-10      0</span><br><span class="line">C00022  2020-06-24      14</span><br><span class="line">C00022  2020-09-16      98</span><br><span class="line">C00023  2020-07-20      0</span><br><span class="line">C00024  2020-07-20      0</span><br><span class="line">C00025  2020-07-18      0</span><br><span class="line">C00025  2020-07-30      12</span><br></pre></td></tr></table></figure>

<h3 id="LEAD-和-LAG"><a href="#LEAD-和-LAG" class="headerlink" title="LEAD() 和 LAG()"></a>LEAD() 和 LAG()</h3><ul>
<li>lead(value_expr[,offset[,default]])：用于统计窗口内往下第n行值。第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL</li>
<li>lag(value_expr[,offset[,default]]): 与lead相反，用于统计窗口内往上第n行值。第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL）</li>
</ul>
<h4 id="需求描述-1"><a href="#需求描述-1" class="headerlink" title="需求描述"></a>需求描述</h4><p>代理商最近一次出售的最高订单金额是多少？</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	agent_code,</span><br><span class="line">	order_amount,</span><br><span class="line">	LAG ( order_amount, <span class="number">1</span> ) <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> agent_code <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_amount <span class="keyword">DESC</span> ) last_highest_amount </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	agent_code,</span><br><span class="line">	order_amount <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h4 id="结果输出-2"><a href="#结果输出-2" class="headerlink" title="结果输出"></a>结果输出</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">A001    800     NULL</span><br><span class="line">A002    4000    NULL</span><br><span class="line">A002    3500    4000</span><br><span class="line">A002    2500    3500</span><br><span class="line">A002    1200    2500</span><br><span class="line">A002    500     1200</span><br><span class="line">A002    500     500</span><br><span class="line">A002    500     500</span><br><span class="line">A003    2500    NULL</span><br><span class="line">A003    1000    2500</span><br><span class="line">A004    4000    NULL</span><br><span class="line">A004    2500    4000</span><br><span class="line">A004    1500    2500</span><br><span class="line">A004    1500    1500</span><br><span class="line">A005    4200    NULL</span><br><span class="line">A005    2000    4200</span><br><span class="line">A005    1500    2000</span><br><span class="line">A006    2500    NULL</span><br><span class="line">A006    500     2500</span><br><span class="line">A007    2000    NULL</span><br><span class="line">A007    500     2000</span><br><span class="line">A008    3500    NULL</span><br><span class="line">A008    3000    3500</span><br><span class="line">A008    1000    3000</span><br><span class="line">A009    500     NULL</span><br><span class="line">A010    4500    NULL</span><br><span class="line">A010    4000    4500</span><br><span class="line">A010    3500    4000</span><br><span class="line">A010    3000    3500</span><br><span class="line">A010    2000    3000</span><br><span class="line">A011    2500    NULL</span><br><span class="line">A011    2500    2500</span><br><span class="line">A012    2000    NULL</span><br><span class="line">A012    900     2000</span><br></pre></td></tr></table></figure>

<h3 id="RANK-和DENSE-RANK"><a href="#RANK-和DENSE-RANK" class="headerlink" title="RANK() 和DENSE_RANK()"></a>RANK() 和DENSE_RANK()</h3><p><strong>rank：</strong>对组中的数据进行排名，如果名次相同，则排名也相同，但是下一个名次的排名序号会出现不连续。比如查找具体条件的topN行。<code>RANK()</code> 排序为 (1,2,2,4)</p>
<p><strong>dense_rank:</strong>dense_rank函数的功能与rank函数类似，dense_rank函数在生成序号时是连续的，而rank函数生成的序号有可能不连续。当出现名次相同时，则排名序号也相同。而下一个排名的序号与上一个排名序号是连续的。</p>
<p><code>DENSE_RANK()</code> 排序为 (1,2,2,3)</p>
<h4 id="需求描述-2"><a href="#需求描述-2" class="headerlink" title="需求描述"></a>需求描述</h4><p>每月第二高的订单金额是多少？</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	order_num,</span><br><span class="line">	order_date,</span><br><span class="line">	order_amount,</span><br><span class="line">	order_month </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	(</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	order_num,</span><br><span class="line">	order_date,</span><br><span class="line">	order_amount,</span><br><span class="line">	<span class="keyword">DATE_FORMAT</span>( order_date, <span class="string">'YYYY-MM'</span> ) <span class="keyword">AS</span> order_month,</span><br><span class="line">	<span class="keyword">DENSE_RANK</span> ( ) <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">DATE_FORMAT</span>( order_date, <span class="string">'YYYY-MM'</span> ) <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_amount <span class="keyword">DESC</span> ) order_rank </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders </span><br><span class="line">	) t </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	order_rank = <span class="number">2</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	order_date;</span><br></pre></td></tr></table></figure>

<h4 id="结果输出-3"><a href="#结果输出-3" class="headerlink" title="结果输出"></a>结果输出</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">200106  2020-04-20      2500    2020-04</span><br><span class="line">200103  2020-05-15      1500    2020-05</span><br><span class="line">200133  2020-06-29      1200    2020-06</span><br><span class="line">200101  2020-07-15      3000    2020-07</span><br><span class="line">200114  2020-08-15      3500    2020-08</span><br><span class="line">200119  2020-09-16      4000    2020-09</span><br><span class="line">200117  2020-10-20      800     2020-10</span><br></pre></td></tr></table></figure>

<h3 id="CUME-DIST"><a href="#CUME-DIST" class="headerlink" title="CUME_DIST()"></a>CUME_DIST()</h3><p>cume_dist:如果按升序排列，则统计：小于等于当前值的行数/总行数(number of rows ≤ current row)/(total number of rows）。如果是降序排列，则统计：大于等于当前值的行数/总行数。比如，统计小于等于当前工资的人数占总人数的比例 ，用于累计统计。</p>
<h4 id="需求描述-3"><a href="#需求描述-3" class="headerlink" title="需求描述"></a>需求描述</h4><p>8月和9月每个订单的收入百分比</p>
<p>先查看一下8月和9月的数据，按订单金额排序</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	order_num,</span><br><span class="line">	order_amount,</span><br><span class="line">	order_date,</span><br><span class="line">	agent_code </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	order_date &gt;= <span class="string">'2020-08-01'</span> </span><br><span class="line">	<span class="keyword">AND</span> order_date &lt;= <span class="string">'2020-09-30'</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">	<span class="keyword">date_format</span>( order_date, <span class="string">"YYYY-MM"</span> ),</span><br><span class="line">	order_amount;</span><br></pre></td></tr></table></figure>

<p>其结果为：</p>
<p><img src="//jiamaoxiang.top/2020/11/26/数仓开发需要了解的5大SQL分析函数/%E7%BB%93%E6%9E%9C.jpg" alt></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	<span class="keyword">DATE_FORMAT</span>( order_date, <span class="string">'YYYY-MM'</span> ) <span class="keyword">AS</span> order_month,</span><br><span class="line">	agent_code,</span><br><span class="line">	order_amount,</span><br><span class="line">	<span class="keyword">CUME_DIST</span> ( ) <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">DATE_FORMAT</span>( order_date, <span class="string">'YYYY-MM'</span> ) <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_amount ) </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	orders </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	order_date &gt;= <span class="string">'2020-08-01'</span> </span><br><span class="line">	<span class="keyword">AND</span> order_date &lt;= <span class="string">'2020-09-30'</span>;</span><br></pre></td></tr></table></figure>

<h4 id="结果输出-4"><a href="#结果输出-4" class="headerlink" title="结果输出"></a>结果输出</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2020-08 A012    900     0.25</span><br><span class="line">2020-08 A003    1000    0.5</span><br><span class="line">2020-08 A008    3500    0.75</span><br><span class="line">2020-08 A010    4500    1.0</span><br><span class="line">2020-09 A002    500     0.16666666666666666</span><br><span class="line">2020-09 A004    1500    0.3333333333333333</span><br><span class="line">2020-09 A010    2000    0.5</span><br><span class="line">2020-09 A004    2500    0.6666666666666666</span><br><span class="line">2020-09 A010    4000    0.8333333333333334</span><br><span class="line">2020-09 A005    4200    1.0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>公众号『大数据技术与数仓』，回复『资料』领取大数据资料包</p>
</blockquote>
</div><div class="recommended_posts"><h3>相关推荐 ☟</h3><li><a href="https://jiamaoxiang.top/2020/12/11/秒懂推荐系统-Spark平台下基于物品的协同过滤推荐系统构建/" target="_blank">秒懂推荐系统-Spark平台下基于物品的协同过滤推荐系统构建</a></li><li><a href="https://jiamaoxiang.top/2020/12/06/如何管理Spark的分区/" target="_blank">如何管理Spark的分区</a></li><li><a href="https://jiamaoxiang.top/2020/11/25/数仓-几种SQL隐藏的错误，你遇到过吗？/" target="_blank">数仓|几种SQL隐藏的错误，你遇到过吗？</a></li><li><a href="https://jiamaoxiang.top/2020/11/20/第十一篇-基于SparkSQL的电影分析项目实战/" target="_blank">第十一篇|基于SparkSQL的电影分析项目实战</a></li></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Jia MaoXiang</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/11/26/数仓开发需要了解的5大SQL分析函数/">https://jiamaoxiang.top/2020/11/26/数仓开发需要了解的5大SQL分析函数/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为博主原创文章，遵循CC BY-SA 4.0版权协议，转载请附上原文出处链接和本声明</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://jiamaoxiang.top/2020/11/26/数仓开发需要了解的5大SQL分析函数/" data-id="ckjzkh52y004zbo7qzh5sosa2" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACrUlEQVR42u3a0Y4iMQwEwP3/n957XWkP6LYTjpNqnhAwmVSQEmP76yu+vn9dj97/+enP7zx6/fzeR+McvvDw8PDWU3/EyF//Hvk57/ms8qX5y2h4eHh413jPN+Jk486nOIM9X8qH7+Ph4eF9JC+ZaHJszA4YPDw8vE/mtXfleDw8PLz/kZckI5ItPpnKLIVxPdeCh4eHF/PytMLnvL5S38PDw8NbV9U3pf226JUfFcU88fDw8C7wZtPatEnlZa0EGaUq8PDw8I7yNoAkVdEmJvLiWfRNPDw8vMu8WetAnvDND4k9GA8PD+8eb/Pn/1RzwCw0L0R4eHh4R3l5eSlvDsjbC9q0RX1I4OHh4V3g7YPpvACWN3UlB8aq3QoPDw/vEG+WbG0TE22YniNfzBYPDw/vAm/WSpWT8taBJNCf3YWHh4d3indjtWYBd9tMEIXgeHh4eNd4syaqzQK1B0myHHh4eHjv583KWnniddjdMCqh4eHh4b2Hl2zim6XZNGzNUhV4eHh4Z3mzh7Wh9r541pa+8PDw8G7z2iE2DQdtaD57Oh4eHt49XktqE7izBqw2AZEfJ3h4eHineHm4nCcIZne1YxZNV3h4eHiHeGcD4rxpoP3+LCjHw8PDu81b1dDWDVh1K1UyHzw8PLwLvJbUAtqmgTa1UXRv4eHh4R3itSmAZIHaLX42clHuwsPDwzvKm7VG1UmBMpXQXi9+Bjw8PLyjvO/ymj2y3eiTpYkWDg8PD+8Cb7P5tsdJG3ZvjpwaiYeHh1fyZm1S+XY8W+k2OYKHh4f3fl5e6JotRDJm0RDQtg7g4eHh/SNe+7AkLM7D67YUh4eHh/cJvFOftkfFKq2Mh4eHd42XB8rtdGfTaoP1hz8YHh4e3gXe7PBoGW3hf5PyGLYO4OHh4b3m/QF4Ww0BFqaRiwAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/数仓/">数仓</a></div><div class="post-nav"><a class="pre" href="/2020/12/06/如何管理Spark的分区/">如何管理Spark的分区</a><a class="next" href="/2020/11/25/数仓-几种SQL隐藏的错误，你遇到过吗？/">数仓|几种SQL隐藏的错误，你遇到过吗？</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-list-ul"> 目录</i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本语法"><span class="toc-number">1.</span> <span class="toc-text">基本语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例"><span class="toc-number">2.</span> <span class="toc-text">案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据准备"><span class="toc-number">2.1.</span> <span class="toc-text">数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AVG-和SUM"><span class="toc-number">2.2.</span> <span class="toc-text">AVG() 和SUM()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#需求描述："><span class="toc-number">2.2.1.</span> <span class="toc-text">需求描述：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#结果输出"><span class="toc-number">2.2.2.</span> <span class="toc-text">结果输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FIRST-VALUE-和-LAST-VALUE"><span class="toc-number">2.3.</span> <span class="toc-text">FIRST_VALUE()和 LAST_VALUE()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#需求描述"><span class="toc-number">2.3.1.</span> <span class="toc-text">需求描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#结果输出-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">结果输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LEAD-和-LAG"><span class="toc-number">2.4.</span> <span class="toc-text">LEAD() 和 LAG()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#需求描述-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">需求描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#结果输出-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">结果输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RANK-和DENSE-RANK"><span class="toc-number">2.5.</span> <span class="toc-text">RANK() 和DENSE_RANK()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#需求描述-2"><span class="toc-number">2.5.1.</span> <span class="toc-text">需求描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#结果输出-3"><span class="toc-number">2.5.2.</span> <span class="toc-text">结果输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CUME-DIST"><span class="toc-number">2.6.</span> <span class="toc-text">CUME_DIST()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#需求描述-3"><span class="toc-number">2.6.1.</span> <span class="toc-text">需求描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#结果输出-4"><span class="toc-number">2.6.2.</span> <span class="toc-text">结果输出</span></a></li></ol></li></ol></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 - 2021 <a href="/." rel="nofollow">Jmx's Blog.</a>All rights reserved.<br>Thoughts on technology, life and everything else.</div></div></div><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.5" zindex="0.7" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>