<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录朴实无华且枯燥的生活"><title>使SQL更易于阅读的几个小技巧 | Jmx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '912b6cfc43243cd27aeb428f7dbf7823';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">使SQL更易于阅读的几个小技巧</h1><a id="logo" href="/.">Jmx's Blog</a><p class="description">Keep it Simple and Stupid!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-pied-piper-alt"> 关于</i></a><a href="/tags"><i class="fa fa-tags"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">使SQL更易于阅读的几个小技巧</h1><div class="post-meta">Jul 9, 2020<span> | </span><span class="category"><a href="/categories/数仓/">数仓</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.5k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 5</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><p>无论是数仓开发还是数据分析，写一手好的SQL是一项基本的技能。毋庸置疑，编写性能较好的SQL是非常重要的，但是，SQL的可读性同样是不容小觑的。一个有着混乱格式的SQL脚本，往往需要花费较长的时间去弄清楚脚本的具体逻辑。如果你曾经被祖传的毫无章法的SQL脚本狂虐过，你一定心有感触。本文将分享几个SQL格式的规范，当然仁者见仁智者见智，其实没有严格的标准，如果有，那就是保证易于阅读和易于维护。</p>
<blockquote>
<p><strong>秦人不暇自哀，而后人哀之；后人哀之而不鉴之，亦使后人而复哀后人也</strong></p>
</blockquote>
<h2 id="大小写保持一致"><a href="#大小写保持一致" class="headerlink" title="大小写保持一致"></a>大小写保持一致</h2><p>可以对SQL关键字使用不同的大小写，但是要保持一致。看看这个：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> customer_city,<span class="keyword">count</span>(*) <span class="keyword">from</span> dim_customer <span class="keyword">WHERE</span> customerProvince = <span class="string">'上海'</span> <span class="keyword">Group</span> <span class="keyword">by</span> customer_city</span><br></pre></td></tr></table></figure>

<p>上面的SQL语句是不是很让人抓狂，大小写混用，看起来很不规范。总结起来，要注意下面几点：</p>
<ul>
<li><p>SQL的关键字可以大写，也可以小写，但是不要大小写混用。上面的SQL查询既有完全大写，也有首字母大写，更有小写。看似是不拘小节，但是万万使不得。</p>
</li>
<li><p>由于大小写是混合的，因此很难区分小写的关键字实际上是关键字还是列。此外，阅读也很烦人。</p>
</li>
<li><p>字段命名要保持一致的风格，上面的SQL与中<code>customer_city</code>是小写加下划线，而<code>customerProvince</code>字段是驼峰命名法，这种不一致性显然是不可取的。</p>
</li>
</ul>
<p>进行一些规范之后后，查询应如下所示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> customer_city,</span><br><span class="line">       <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> dim_customer</span><br><span class="line"><span class="keyword">WHERE</span> customer_province = <span class="string">'上海'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> customer_city</span><br></pre></td></tr></table></figure>

<h2 id="使用缩进"><a href="#使用缩进" class="headerlink" title="使用缩进"></a>使用缩进</h2><p>再来看看下面的一条查询语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dp.region_name,<span class="keyword">count</span>(*) <span class="keyword">FROM</span> user_behavior_log ubl <span class="keyword">JOIN</span> dim_province dp <span class="keyword">ON</span> ubl.province = dp.province_name <span class="keyword">WHERE</span> ubl.province = <span class="string">'上海市'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> dp.region_name</span><br></pre></td></tr></table></figure>

<p>将上面的SQL语句格式化下面的形式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> dp.region_name, <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> user_behavior_log ubl</span><br><span class="line"><span class="keyword">JOIN</span> dim_province dp <span class="keyword">ON</span> ubl.province = dp.province_name</span><br><span class="line"><span class="keyword">WHERE</span> ubl.province = <span class="string">'上海市'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> dp.region_name</span><br></pre></td></tr></table></figure>

<p>上面的格式化形式似乎清晰了很多，但是如果语句中包含了子查询、多个JOIN以及窗口函数时，同样会显得对阅读不是很友好。</p>
<p>再换一种格式化方式，如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    dp.region_name, </span><br><span class="line">    <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> user_behavior_log ubl</span><br><span class="line">    <span class="keyword">JOIN</span> dim_province dp <span class="keyword">ON</span> ubl.province = dp.province_name</span><br><span class="line"><span class="keyword">WHERE</span> ubl.province = <span class="string">'上海市'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    dp.region_name</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者下面的形式</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    dp.region_name </span><br><span class="line">    ,<span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> user_behavior_log ubl</span><br><span class="line">    <span class="keyword">JOIN</span> dim_province dp <span class="keyword">ON</span> ubl.province = dp.province_name</span><br><span class="line"><span class="keyword">WHERE</span> ubl.province = <span class="string">'上海市'</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    dp.region_name</span><br></pre></td></tr></table></figure>

<blockquote>
<p>尖叫提示：对于第二种形式，在SELECT字段中，从第二个字段开始，每个字段前面添加一个逗号，而不是每个字段后面使用逗号结尾。这种方式可以很方便地识别FROM前面是否存在逗号，从而造成语法错误。当然，这个只是个人习惯问题，并不是硬性的规定。</p>
<p>另外上面的SQL语句使用了4个字符缩进，当然也可以选择2个字符缩进，这个也是个人习惯问题。</p>
</blockquote>
<h2 id="在group-by-和order-by之后使用字段的排列序号"><a href="#在group-by-和order-by之后使用字段的排列序号" class="headerlink" title="在group by 和order by之后使用字段的排列序号"></a>在group by 和order by之后使用字段的排列序号</h2><p>同样，这种书写风格也是个人的一种偏好，并不是一条硬性规定。应该有很多的初学者对此种写法并不是很清楚。</p>
<p>看下面的这条SQL：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    dp.region_name, </span><br><span class="line">    dp.province_name,</span><br><span class="line">    <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> user_behavior_log ubl</span><br><span class="line">    <span class="keyword">JOIN</span> dim_province dp <span class="keyword">ON</span> ubl.province = dp.province_name</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    dp.region_name,</span><br><span class="line">    dp.province_name</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">    <span class="keyword">count</span>(*) <span class="keyword">desc</span> <span class="comment">-- Hive不支持</span></span><br></pre></td></tr></table></figure>

<p>可以写成下面的形式：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 注意：MySQL、Impala支持这种写法，Hive不支持</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    dp.region_name, </span><br><span class="line">    dp.province_name,</span><br><span class="line">    <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> user_behavior_log ubl</span><br><span class="line">    <span class="keyword">JOIN</span> dim_province dp <span class="keyword">ON</span> ubl.province = dp.province_name</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="number">1</span>,<span class="number">2</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>这样写有如下的好处：</p>
<ul>
<li><strong>可以节省行</strong>：通过许多字段进行分组不仅会在SELECT子句中添加更多行，还会在GROUP BY和ORDER BY子句中添加更多行，甚至可能使查询中的行数增加一倍。</li>
<li><strong>可维护性</strong>：如果想改变分组字段，只需在SELECT子句中进行操作，在GROUP BY语句中不需要修改。</li>
<li><strong>方便：</strong>只需要GROUP BY 1，2，3，…，n，其中n为分组列的字段序号。</li>
</ul>
<h2 id="使用Common-Table表达式-with语句"><a href="#使用Common-Table表达式-with语句" class="headerlink" title="使用Common Table表达式(with语句)"></a>使用Common Table表达式(with语句)</h2><p>该方式称之为<strong>Common Table Expressions(CTE)</strong>,用来简化复杂查询。它们可以定义为临时视图，因为它们仅在整个查询执行期间存在。</p>
<p>看一个简单的例子：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 注意Hive、Impala支持这种语法，低版本的MySQL不支持(高版本支持)</span></span><br><span class="line"><span class="keyword">WITH</span> employee_by_title_count <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span></span><br><span class="line">        t.name <span class="keyword">as</span> job_title</span><br><span class="line">        , <span class="keyword">COUNT</span>(e.id) <span class="keyword">as</span> amount_of_employees</span><br><span class="line">    <span class="keyword">FROM</span> employees e</span><br><span class="line">        <span class="keyword">JOIN</span> job_titles t <span class="keyword">on</span> e.job_title_id = t.id</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="number">1</span></span><br><span class="line">),</span><br><span class="line">salaries_by_title <span class="keyword">AS</span> (</span><br><span class="line">     <span class="keyword">SELECT</span></span><br><span class="line">         <span class="keyword">name</span> <span class="keyword">as</span> job_title</span><br><span class="line">         , salary</span><br><span class="line">     <span class="keyword">FROM</span> job_titles</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> employee_by_title_count e</span><br><span class="line">    <span class="keyword">JOIN</span> salaries_by_title s <span class="keyword">ON</span> s.job_title = e.job_title</span><br></pre></td></tr></table></figure>

<p>上面的语句中，最终的查询使用<code>employee_by_title</code>和<code>salaries_by_title</code>的两个结果集进行JOIN产生最终结果。这比在SELECT子句中或直接在FROM子句中进行子查询更具可读性和可维护性。</p>
<h2 id="使用具有描述性的别名"><a href="#使用具有描述性的别名" class="headerlink" title="使用具有描述性的别名"></a>使用具有描述性的别名</h2><p>这一点非常重要，如果查询的列字段很多，肯能会存在一些id，count(*)等，很难辨识代表什么含义，所以需要为每个查询列加上可读的、易于理解的别名，能够让其他人一眼就能看出代表什么含义，这样可以增加脚本的可维护性。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>文中提到的一些规范有些是必须要遵守的，有些是个人的编码习惯，无论你是开发人员、数据分析师、数仓开发，遵循一些规范可以避免不必要的麻烦。值得注意的是，关于SQL的格式，没有一个标准的约定，需要与团队的其他成员达成共识，一起按照相同的约定进行开发，从而可以大大提高脚本的可读性和可维护性。</p>
<blockquote>
<p>公众号『大数据技术与数仓』，回复『资料』领取大数据资料包</p>
</blockquote>
</div><div class="recommended_posts"><h3>相关推荐 ☟</h3><li><a href="https://jiamaoxiang.top/2020/07/14/第一篇-Spark概览/" target="_blank">第一篇|Spark概览</a></li><li><a href="https://jiamaoxiang.top/2020/07/11/数仓-大数据时代-维度建模过时了吗/" target="_blank">数仓|大数据时代,维度建模过时了吗?</a></li><li><a href="https://jiamaoxiang.top/2020/07/06/Kafka的Controller-Broker是什么/" target="_blank">Kafka的Controller Broker是什么</a></li><li><a href="https://jiamaoxiang.top/2020/07/05/Kafka生产者ack机制剖析/" target="_blank">Kafka生产者ack机制剖析</a></li></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Jia MaoXiang</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/07/09/使SQL更易于阅读的几个小技巧/">https://jiamaoxiang.top/2020/07/09/使SQL更易于阅读的几个小技巧/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为博主原创文章，遵循CC BY-SA 4.0版权协议，转载请附上原文出处链接和本声明</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://jiamaoxiang.top/2020/07/09/使SQL更易于阅读的几个小技巧/" data-id="ckgyvdevb0013eg7qf82fy1ak" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACvUlEQVR42u3aUW7jMAwFwN7/0t0DBLXfI6WiWIy/gtRVNA4gMiS/vuLr++P6/Ovz6+d3kjU/7zl24eHh4a23/rnc8zv5f+UPK1/5eTU8PDy8e7yfTtT2mM6Rz/c/P4hkz3h4eHh/jbdPfJNjHQ8PD+9/4s3KCm2oyMsceHh4eL/PS378JwlxssX8/U0pBA8PD+8eL09//87rK/09PDw8vHVXPQ8Szx+cH+J5MTfaLR4eHt4FXn7g3kuFk7LFbJ94eHh4t3ltSGhbX22YyUPRy/14eHh4F3htcTZvnuVts2SYoGbg4eHhXeDNCgTtJvIHkYSiZOwADw8P7x5vs+lZGSJJsmcNuR9XwMPDwzvK2/zI32x3U7YoAhUeHh7eBd6s0JDjZw8rL3AUrTI8PDy8Q7zNsVscymUAaEcHonErPDw8vEO89hCfjRFsQkg70FBEMDw8PLwFLz+O91vPk+kNI/o+8fDw8A7x8jGCPPFthwzywYXiG8PDw8O7wGuLC/lwQHuI7wsceHh4eL/D2zefZoNW+f15wHj5DvHw8PAO8dp0uR2xyosUSQreDoTh4eHhneKdCgN5Yj2MV7NBBDw8PLwLvDx5bUuueeE1H6tqAw8eHh7eDd6+KHB21KAti7ysj4eHh3eBdyok7IsaeSuu3i0eHh7eNd7s9b793w5dRTXpzRJ4eHh4MW+GTFr77VBCm3C/fBYeHh7eNV6eXj/z2rLFrAmXRwE8PDy8s7zv8rpdjBiWG5KeHh4eHt4h3iqelIvmgSRpy+UtNzw8PLwbvCQYtO3//HDfs4v+Hh4eHt5R3qxUmgSG2SNrg9axHB8PDw/vAm9WtM3LCm3p4WU1PDw8vD/AyxPx2TBBzohGr/Dw8PCu8fLSwKyg0IaBtgE27PLh4eHhjXjtD/5TCXQ7oJCk+KvRATw8PLz3/fwD6oaSly99y6sAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/数仓/">数仓</a></div><div class="post-nav"><a class="pre" href="/2020/07/11/数仓-大数据时代-维度建模过时了吗/">数仓|大数据时代,维度建模过时了吗?</a><a class="next" href="/2020/07/06/Kafka的Controller-Broker是什么/">Kafka的Controller Broker是什么</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-list-ul"> 目录</i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#大小写保持一致"><span class="toc-number">1.</span> <span class="toc-text">大小写保持一致</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用缩进"><span class="toc-number">2.</span> <span class="toc-text">使用缩进</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在group-by-和order-by之后使用字段的排列序号"><span class="toc-number">3.</span> <span class="toc-text">在group by 和order by之后使用字段的排列序号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用Common-Table表达式-with语句"><span class="toc-number">4.</span> <span class="toc-text">使用Common Table表达式(with语句)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用具有描述性的别名"><span class="toc-number">5.</span> <span class="toc-text">使用具有描述性的别名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 - 2020 <a href="/." rel="nofollow">Jmx's Blog.</a>All rights reserved.<br>Thoughts on technology, life and everything else.</div></div></div><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.5" zindex="0.7" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>