<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录朴实无华且枯燥的生活"><title>项目实践|基于Flink的用户行为日志分析系统 | Jmx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '912b6cfc43243cd27aeb428f7dbf7823';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">项目实践|基于Flink的用户行为日志分析系统</h1><a id="logo" href="/.">Jmx's Blog</a><p class="description">Keep it Simple and Stupid!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-pied-piper-alt"> 关于</i></a><a href="/tags"><i class="fa fa-tags"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">项目实践|基于Flink的用户行为日志分析系统</h1><div class="post-meta">Aug 29, 2020<span> | </span><span class="category"><a href="/categories/Flink/">Flink</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 20</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><a id="more"></a>

<p>用户行为日志分析是实时数据处理很常见的一个应用场景，比如常见的PV、UV统计。本文将基于Flink从0到1构建一个用户行为日志分析系统，包括架构设计与代码实现。本文分享将完整呈现日志分析系统的数据处理链路，通过本文，你可以了解到：</p>
<ul>
<li>基于discuz搭建一个论坛平台</li>
<li>Flume日志收集系统使用方式</li>
<li>Apache日志格式分析</li>
<li>Flume与Kafka集成</li>
<li>日志分析处理流程</li>
<li>架构设计与完整的代码实现</li>
</ul>
<h2 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h2><p>本文分享会从0到1基于Flink实现一个实时的用户行为日志分析系统，基本架构图如下：</p>
<p><img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/%E6%97%A5%E5%BF%97%E6%9E%B6%E6%9E%84.png" alt></p>
<p>首先会先搭建一个论坛平台，对论坛平台产生的用户点击日志进行分析。然后使用Flume日志收集系统对产生的Apache日志进行收集，并将其推送到Kafka。接着我们使用Flink对日志进行实时分析处理，将处理之后的结果写入MySQL供前端应用可视化展示。本文主要实现以下三个指标计算：</p>
<ul>
<li>统计热门板块，即访问量最高的板块</li>
<li>统计热门文章，即访问量最高的帖子文章</li>
<li>统计不同客户端对版块和文章的总访问量</li>
</ul>
<h2 id="基于discuz搭建一个论坛平台"><a href="#基于discuz搭建一个论坛平台" class="headerlink" title="基于discuz搭建一个论坛平台"></a>基于discuz搭建一个论坛平台</h2><h3 id="安装XAMPP"><a href="#安装XAMPP" class="headerlink" title="安装XAMPP"></a>安装XAMPP</h3><ul>
<li>下载</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget https://www.apachefriends.org/xampp-files/5.6.33/xampp-linux-x64-5.6.33-0-installer.run</span><br></pre></td></tr></table></figure>

<ul>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 赋予文件执行权限</span></span><br><span class="line">chmod u+x xampp-linux-x64-5.6.33-0-installer.run</span><br><span class="line"><span class="comment"># 运行安装文件</span></span><br><span class="line">./xampp-linux-x64-5.6.33-0-installer.run</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置环境变量</p>
<p>将以下内容加入到 ~/.bash_profile </p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> XAMPP=/opt/lampp/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$XAMPP</span>:<span class="variable">$XAMPP</span>/bin</span><br></pre></td></tr></table></figure>

<ul>
<li>刷新环境变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure>

<ul>
<li>启动XAMPP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xampp restart</span><br></pre></td></tr></table></figure>

<ul>
<li>MySQL的root用户密码和权限修改</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#修改root用户密码为123qwe </span></span><br><span class="line">update mysql.user <span class="built_in">set</span> password=PASSWORD(<span class="string">'123qwe'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>; </span><br><span class="line">flush privileges;  </span><br><span class="line"><span class="comment">#赋予root用户远程登录权限 </span></span><br><span class="line">grant all privileges on *.* to <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'123qwe'</span> with grant option;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<h3 id="安装Discuz"><a href="#安装Discuz" class="headerlink" title="安装Discuz"></a>安装Discuz</h3><ul>
<li>下载discuz</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://download.comsenz.com/DiscuzX/3.2/Discuz_X3.2_SC_UTF8.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#删除原有的web应用  </span></span><br><span class="line">rm -rf /opt/lampp/htdocs/*</span><br><span class="line">unzip Discuz_X3.2_SC_UTF8.zip –d /opt/lampp/htdocs/</span><br><span class="line"><span class="built_in">cd</span> /opt/lampp/htdocs/  </span><br><span class="line">mv upload/*   </span><br><span class="line"><span class="comment">#修改目录权限 </span></span><br><span class="line">chmod 777 -R /opt/lampp/htdocs/config/</span><br><span class="line">chmod 777 -R /opt/lampp/htdocs/data/</span><br><span class="line">chmod 777 -R /opt/lampp/htdocs/uc_client/  </span><br><span class="line">chmod 777 -R /opt/lampp/htdocs/uc_server/</span><br></pre></td></tr></table></figure>

<h3 id="Discuz基本操作"><a href="#Discuz基本操作" class="headerlink" title="Discuz基本操作"></a>Discuz基本操作</h3><ul>
<li>自定义版块  </li>
<li>进入discuz后台：<a href="http://kms-4/admin.php" target="_blank" rel="noopener">http://kms-4/admin.php</a>  </li>
<li>点击顶部的<strong>论坛</strong>菜单  </li>
<li>按照页面提示创建所需版本，可以创建父子版块  </li>
</ul>
<img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/板块.png" style="zoom: 50%;">

<h3 id="Discuz帖子-版块存储数据库表介"><a href="#Discuz帖子-版块存储数据库表介" class="headerlink" title="Discuz帖子/版块存储数据库表介"></a>Discuz帖子/版块存储数据库表介</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 登录ultrax数据库</span></span><br><span class="line">mysql -uroot -p123 ultrax </span><br><span class="line"><span class="comment">-- 查看包含帖子id及标题对应关系的表</span></span><br><span class="line"><span class="comment">-- tid, subject（文章id、标题）</span></span><br><span class="line"><span class="keyword">select</span> tid, subject <span class="keyword">from</span> pre_forum_post <span class="keyword">limit</span> <span class="number">10</span>;</span><br><span class="line"><span class="comment">-- fid, name（版块id、标题）</span></span><br><span class="line"><span class="keyword">select</span> fid, <span class="keyword">name</span> <span class="keyword">from</span> pre_forum_forum <span class="keyword">limit</span> <span class="number">40</span>;</span><br></pre></td></tr></table></figure>

<p>当我们在各个板块添加帖子之后，如下所示：</p>
<img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/帖子.png" style="zoom:50%;">

<h3 id="修改日志格式"><a href="#修改日志格式" class="headerlink" title="修改日志格式"></a>修改日志格式</h3><ul>
<li>查看访问日志</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 日志默认地址  </span></span><br><span class="line">/opt/lampp/logs/access_log </span><br><span class="line"><span class="comment"># 实时查看日志命令  </span></span><br><span class="line">tail –f /opt/lampp/logs/access_log</span><br></pre></td></tr></table></figure>

<ul>
<li>修改日志格式</li>
</ul>
<p>Apache配置文件名称为httpd.conf，完整路径为<code>/opt/lampp/etc/httpd.conf</code>。由于默认的日志类型为<strong>common</strong>类型，总共有7个字段。为了获取更多的日志信息，我们需要将其格式修改为<strong>combined</strong>格式，该日志格式共有9个字段。修改方式如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启用组合日志文件</span></span><br><span class="line">CustomLog <span class="string">"logs/access_log"</span> combined</span><br></pre></td></tr></table></figure>

<img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/日志格式.png" style="zoom:50%;">

<ul>
<li>重新加载配置文件 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">xampp reload</span><br></pre></td></tr></table></figure>

<h3 id="Apache日志格式介绍"><a href="#Apache日志格式介绍" class="headerlink" title="Apache日志格式介绍"></a>Apache日志格式介绍</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.10.1 - - [30/Aug/2020:15:53:15 +0800] <span class="string">"GET /forum.php?mod=forumdisplay&amp;fid=43 HTTP/1.1"</span> 200 30647 <span class="string">"http://kms-4/forum.php"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"</span></span><br></pre></td></tr></table></figure>

<p>上面的日志格式共有9个字段，分别用空格隔开。每个字段的具体含义如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.10.1 <span class="comment">##(1)客户端的IP地址</span></span><br><span class="line">- <span class="comment">## (2)客户端identity标识,该字段为"-"</span></span><br><span class="line">- <span class="comment">## (3)客户端userid标识,该字段为"-"</span></span><br><span class="line">[30/Aug/2020:15:53:15 +0800] <span class="comment">## (4)服务器完成请求处理时的时间</span></span><br><span class="line"><span class="string">"GET /forum.php?mod=forumdisplay&amp;fid=43 HTTP/1.1"</span> <span class="comment">## (5)请求类型 请求的资源 使用的协议</span></span><br><span class="line">200 <span class="comment">## (6)服务器返回给客户端的状态码，200表示成功</span></span><br><span class="line">30647 <span class="comment">## (7)返回给客户端不包括响应头的字节数，如果没有信息返回，则此项应该是"-"</span></span><br><span class="line"><span class="string">"http://kms-4/forum.php"</span> <span class="comment">## (8)Referer请求头</span></span><br><span class="line"><span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135 Safari/537.36"</span> <span class="comment">## (9)客户端的浏览器信息</span></span><br></pre></td></tr></table></figure>

<p>关于上面的日志格式，可以使用正则表达式进行匹配：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;\.\d&#123;1,3&#125;) (\S+) (\S+) (\[.+?\]) (\"(.*?)\") (\d&#123;3&#125;) (\S+) (\"(.*?)\") (\"(.*?)\")</span><br></pre></td></tr></table></figure>

<h2 id="Flume与Kafka集成"><a href="#Flume与Kafka集成" class="headerlink" title="Flume与Kafka集成"></a>Flume与Kafka集成</h2><p>本文使用Flume对产生的Apache日志进行收集，然后推送至Kafka。需要启动Flume agent对日志进行收集，对应的配置文件如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># agent的名称为a1</span></span><br><span class="line">a1.sources = source1</span><br><span class="line">a1.channels = channel1</span><br><span class="line">a1.sinks = sink1</span><br><span class="line"></span><br><span class="line"><span class="comment"># set source</span></span><br><span class="line">a1.sources.source1.type = TAILDIR</span><br><span class="line">a1.sources.source1.filegroups = f1</span><br><span class="line">a1.sources.source1.filegroups.f1 = /opt/lampp/logs/access_log</span><br><span class="line">a1sources.source1.fileHeader = flase</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置sink</span></span><br><span class="line">a1.sinks.sink1.type = org.apache.flume.sink.kafka.KafkaSink</span><br><span class="line">a1.sinks.sink1.brokerList=kms-2:9092,kms-3:9092,kms-4:9092</span><br><span class="line">a1.sinks.sink1.topic= user_access_logs</span><br><span class="line">a1.sinks.sink1.kafka.flumeBatchSize = 20</span><br><span class="line">a1.sinks.sink1.kafka.producer.acks = 1</span><br><span class="line">a1.sinks.sink1.kafka.producer.linger.ms = 1</span><br><span class="line">a1.sinks.sink1.kafka.producer.compression.type = snappy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置channel</span></span><br><span class="line">a1.channels.channel1.type = file</span><br><span class="line">a1.channels.channel1.checkpointDir = /home/kms/data/flume_data/checkpoint</span><br><span class="line">a1.channels.channel1.dataDirs= /home/kms/data/flume_data/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置bind</span></span><br><span class="line">a1.sources.source1.channels = channel1</span><br><span class="line">a1.sinks.sink1.channel = channel1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>知识点：</p>
<p><strong>Taildir Source</strong>相比<strong>Exec Source</strong>、<strong>Spooling Directory Source</strong>的优势是什么？</p>
<p><strong>TailDir Source</strong>：断点续传、多目录。Flume1.6以前需要自己自定义Source记录每次读取文件位置,实现断点续传</p>
<p><strong>Exec Source</strong>：可以实时收集数据,但是在Flume不运行或者Shell命令出错的情况下,数据将会丢失</p>
<p><strong>Spooling Directory Source</strong>：监控目录,不支持断点续传</p>
</blockquote>
<p>值得注意的是，上面的配置是直接将原始日志push到Kafka。除此之外，我们还可以自定义Flume的拦截器对原始日志先进行过滤处理，同时也可以实现将不同的日志push到Kafka的不同Topic中。</p>
<h3 id="启动Flume-Agent"><a href="#启动Flume-Agent" class="headerlink" title="启动Flume Agent"></a>启动Flume Agent</h3><p>将启动Agent的命令封装成shell脚本:*<em>start-log-collection.sh *</em>,脚本内容如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">echo "start log agent !!!"</span><br><span class="line">/opt/modules/apache-flume-1.9.0-bin/bin/flume-ng agent --conf-file /opt/modules/apache-flume-1.9.0-bin/conf/log_collection.conf --name a1 -Dflume.root.logger=INFO,console</span><br></pre></td></tr></table></figure>

<h3 id="查看push到Kafka的日志数据"><a href="#查看push到Kafka的日志数据" class="headerlink" title="查看push到Kafka的日志数据"></a>查看push到Kafka的日志数据</h3><p>将控制台消费者命令封装成shell脚本：<strong>kafka-consumer.sh</strong>，脚本内容如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"kafka consumer "</span></span><br><span class="line">bin/kafka-console-consumer.sh  --bootstrap-server kms-2.apache.com:9092,kms-3.apache.com:9092,kms-4.apache.com:9092  --topic <span class="variable">$1</span> --from-beginning</span><br></pre></td></tr></table></figure>

<p>使用下面命令消费Kafka中的数据：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[kms@kms-2 kafka_2.11-2.1.0]$ ./kafka-consumer.sh  user_access_logs</span><br></pre></td></tr></table></figure>

<h2 id="日志分析处理流程"><a href="#日志分析处理流程" class="headerlink" title="日志分析处理流程"></a>日志分析处理流程</h2><p>为了方便解释，下面会对重要代码进行讲解，完整代码移步<strong>github</strong>：<a href="https://github.com/jiamx/flink-log-analysis" target="_blank" rel="noopener">https://github.com/jiamx/flink-log-analysis</a></p>
<p><img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/F:%5Cnpm%5Cmywebsite%5Csource_posts%5C%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5-%E5%9F%BA%E4%BA%8EFlink%E7%9A%84%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F%5C%E9%A1%B9%E7%9B%AE%E4%BB%A3%E7%A0%81.png" alt></p>
<h3 id="创建MySQL数据库和目标表"><a href="#创建MySQL数据库和目标表" class="headerlink" title="创建MySQL数据库和目标表"></a>创建MySQL数据库和目标表</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 客户端访问量统计</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`client_ip_access`</span> (</span><br><span class="line">  <span class="string">`client_ip`</span> <span class="built_in">char</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'客户端ip'</span>,</span><br><span class="line">  <span class="string">`client_access_cnt`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'访问次数'</span>,</span><br><span class="line">  <span class="string">`statistic_time`</span> <span class="built_in">text</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'统计时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`client_ip`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="comment">-- 热门文章统计</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`hot_article`</span> (</span><br><span class="line">  <span class="string">`article_id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'文章id'</span>,</span><br><span class="line">  <span class="string">`subject`</span> <span class="built_in">varchar</span>(<span class="number">80</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'文章标题'</span>,</span><br><span class="line">  <span class="string">`article_pv`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'访问次数'</span>,</span><br><span class="line">  <span class="string">`statistic_time`</span> <span class="built_in">text</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'统计时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`article_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"><span class="comment">-- 热门板块统计</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`hot_section`</span> (</span><br><span class="line">  <span class="string">`section_id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'版块id'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">char</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'版块标题'</span>,</span><br><span class="line">  <span class="string">`section_pv`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'访问次数'</span>,</span><br><span class="line">  <span class="string">`statistic_time`</span> <span class="built_in">text</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'统计时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`section_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<h3 id="AccessLogRecord类"><a href="#AccessLogRecord类" class="headerlink" title="AccessLogRecord类"></a>AccessLogRecord类</h3><p>该类封装了日志所包含的字段数据，共有9个字段。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用lombok</span></span><br><span class="line"><span class="comment"> * 原始日志封装类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessLogRecord</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String clientIpAddress; <span class="comment">// 客户端ip地址</span></span><br><span class="line">    <span class="keyword">public</span> String clientIdentity; <span class="comment">// 客户端身份标识,该字段为 `-`</span></span><br><span class="line">    <span class="keyword">public</span> String remoteUser; <span class="comment">// 用户标识,该字段为 `-`</span></span><br><span class="line">    <span class="keyword">public</span> String dateTime; <span class="comment">//日期,格式为[day/month/yearhourminutesecond zone]</span></span><br><span class="line">    <span class="keyword">public</span> String request; <span class="comment">// url请求,如：`GET /foo ...`</span></span><br><span class="line">    <span class="keyword">public</span> String httpStatusCode; <span class="comment">// 状态码，如：200; 404.</span></span><br><span class="line">    <span class="keyword">public</span> String bytesSent; <span class="comment">// 传输的字节数，有可能是 `-`</span></span><br><span class="line">    <span class="keyword">public</span> String referer; <span class="comment">// 参考链接,即来源页</span></span><br><span class="line">    <span class="keyword">public</span> String userAgent;  <span class="comment">// 浏览器和操作系统类型</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LogParse类"><a href="#LogParse类" class="headerlink" title="LogParse类"></a>LogParse类</h3><p>该类是日志解析类，通过正则表达式对日志进行匹配，对匹配上的日志进行按照字段解析。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogParse</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建正则表达式</span></span><br><span class="line">    <span class="keyword">private</span> String regex = <span class="string">"(\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;\\.\\d&#123;1,3&#125;) (\\S+) (\\S+) (\\[.+?\\]) (\\\"(.*?)\\\") (\\d&#123;3&#125;) (\\S+) (\\\"(.*?)\\\") (\\\"(.*?)\\\")"</span>;</span><br><span class="line">    <span class="keyword">private</span> Pattern p = Pattern.compile(regex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *构造访问日志的封装类对象</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccessLogRecord <span class="title">buildAccessLogRecord</span><span class="params">(Matcher matcher)</span> </span>&#123;</span><br><span class="line">        AccessLogRecord record = <span class="keyword">new</span> AccessLogRecord();</span><br><span class="line">        record.setClientIpAddress(matcher.group(<span class="number">1</span>));</span><br><span class="line">        record.setClientIdentity(matcher.group(<span class="number">2</span>));</span><br><span class="line">        record.setRemoteUser(matcher.group(<span class="number">3</span>));</span><br><span class="line">        record.setDateTime(matcher.group(<span class="number">4</span>));</span><br><span class="line">        record.setRequest(matcher.group(<span class="number">5</span>));</span><br><span class="line">        record.setHttpStatusCode(matcher.group(<span class="number">6</span>));</span><br><span class="line">        record.setBytesSent(matcher.group(<span class="number">7</span>));</span><br><span class="line">        record.setReferer(matcher.group(<span class="number">8</span>));</span><br><span class="line">        record.setUserAgent(matcher.group(<span class="number">9</span>));</span><br><span class="line">        <span class="keyword">return</span> record;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> record:record表示一条apache combined 日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解析日志记录，将解析的日志封装成一个AccessLogRecord类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AccessLogRecord <span class="title">parseRecord</span><span class="params">(String record)</span> </span>&#123;</span><br><span class="line">        Matcher matcher = p.matcher(record);</span><br><span class="line">        <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">            <span class="keyword">return</span> buildAccessLogRecord(matcher);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request url请求，类型为字符串，类似于 "GET /the-uri-here HTTP/1.1"</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一个三元组(requestType, uri, httpVersion). requestType表示请求类型，如GET, POST等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tuple3&lt;String, String, String&gt; <span class="title">parseRequestField</span><span class="params">(String request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//请求的字符串格式为：“GET /test.php HTTP/1.1”，用空格切割</span></span><br><span class="line">        String[] arr = request.split(<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">if</span> (arr.length == <span class="number">3</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Tuple3.of(arr[<span class="number">0</span>], arr[<span class="number">1</span>], arr[<span class="number">2</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将apache日志中的英文日期转化为指定格式的中文日期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dateTime 传入的apache日志中的日期字符串，"[21/Jul/2009:02:48:13 -0700]"</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">parseDateField</span><span class="params">(String dateTime)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="comment">// 输入的英文日期格式</span></span><br><span class="line">        String inputFormat = <span class="string">"dd/MMM/yyyy:HH:mm:ss"</span>;</span><br><span class="line">        <span class="comment">// 输出的日期格式</span></span><br><span class="line">        String outPutFormat = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>;</span><br><span class="line"></span><br><span class="line">        String dateRegex = <span class="string">"\\[(.*?) .+]"</span>;</span><br><span class="line">        Pattern datePattern = Pattern.compile(dateRegex);</span><br><span class="line"></span><br><span class="line">        Matcher dateMatcher = datePattern.matcher(dateTime);</span><br><span class="line">        <span class="keyword">if</span> (dateMatcher.find()) &#123;</span><br><span class="line">            String dateString = dateMatcher.group(<span class="number">1</span>);</span><br><span class="line">            SimpleDateFormat dateInputFormat = <span class="keyword">new</span> SimpleDateFormat(inputFormat, Locale.ENGLISH);</span><br><span class="line">            Date date = dateInputFormat.parse(dateString);</span><br><span class="line"></span><br><span class="line">            SimpleDateFormat dateOutFormat = <span class="keyword">new</span> SimpleDateFormat(outPutFormat);</span><br><span class="line"></span><br><span class="line">            String formatDate = dateOutFormat.format(date);</span><br><span class="line">            <span class="keyword">return</span> formatDate;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析request,即访问页面的url信息解析</span></span><br><span class="line"><span class="comment">     * "GET /about/forum.php?mod=viewthread&amp;tid=5&amp;extra=page%3D1 HTTP/1.1"</span></span><br><span class="line"><span class="comment">     * 匹配出访问的fid:版本id</span></span><br><span class="line"><span class="comment">     * 以及tid：文章id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Tuple2&lt;String, String&gt; <span class="title">parseSectionIdAndArticleId</span><span class="params">(String request)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 匹配出前面是"forumdisplay&amp;fid="的数字记为版块id</span></span><br><span class="line">        String sectionIdRegex = <span class="string">"(\\?mod=forumdisplay&amp;fid=)(\\d+)"</span>;</span><br><span class="line">        Pattern sectionPattern = Pattern.compile(sectionIdRegex);</span><br><span class="line">        <span class="comment">// 匹配出前面是"tid="的数字记为文章id</span></span><br><span class="line">        String articleIdRegex = <span class="string">"(\\?mod=viewthread&amp;tid=)(\\d+)"</span>;</span><br><span class="line">        Pattern articlePattern = Pattern.compile(articleIdRegex);</span><br><span class="line"></span><br><span class="line">        String[] arr = request.split(<span class="string">" "</span>);</span><br><span class="line">        String sectionId = <span class="string">""</span>;</span><br><span class="line">        String articleId = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (arr.length == <span class="number">3</span>) &#123;</span><br><span class="line">            Matcher sectionMatcher = sectionPattern.matcher(arr[<span class="number">1</span>]);</span><br><span class="line">            Matcher articleMatcher = articlePattern.matcher(arr[<span class="number">1</span>]);</span><br><span class="line">                sectionId = (sectionMatcher.find()) ? sectionMatcher.group(<span class="number">2</span>) : <span class="string">""</span>;</span><br><span class="line">               articleId = (articleMatcher.find()) ? articleMatcher.group(<span class="number">2</span>) : <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  Tuple2.of(sectionId, articleId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LogAnalysis类"><a href="#LogAnalysis类" class="headerlink" title="LogAnalysis类"></a>LogAnalysis类</h3><p>该类是日志处理的基本逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAnalysis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        StreamExecutionEnvironment senv = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        <span class="comment">// 开启checkpoint，时间间隔为毫秒</span></span><br><span class="line">        senv.enableCheckpointing(<span class="number">5000L</span>);</span><br><span class="line">        <span class="comment">// 选择状态后端</span></span><br><span class="line">        <span class="comment">// 本地测试</span></span><br><span class="line">        <span class="comment">// senv.setStateBackend(new FsStateBackend("file:///E://checkpoint"));</span></span><br><span class="line">        <span class="comment">// 集群运行</span></span><br><span class="line">        senv.setStateBackend(<span class="keyword">new</span> FsStateBackend(<span class="string">"hdfs://kms-1:8020/flink-checkpoints"</span>));</span><br><span class="line">        <span class="comment">// 重启策略</span></span><br><span class="line">        senv.setRestartStrategy(</span><br><span class="line">                RestartStrategies.fixedDelayRestart(<span class="number">3</span>, Time.of(<span class="number">2</span>, TimeUnit.SECONDS) ));</span><br><span class="line"></span><br><span class="line">        EnvironmentSettings settings = EnvironmentSettings.newInstance()</span><br><span class="line">                .useBlinkPlanner()</span><br><span class="line">                .inStreamingMode()</span><br><span class="line">                .build();</span><br><span class="line">        StreamTableEnvironment tEnv = StreamTableEnvironment.create(senv, settings);</span><br><span class="line">        <span class="comment">// kafka参数配置</span></span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="comment">// kafka broker地址</span></span><br><span class="line">        props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"kms-2:9092,kms-3:9092,kms-4:9092"</span>);</span><br><span class="line">        <span class="comment">// 消费者组</span></span><br><span class="line">        props.put(<span class="string">"group.id"</span>, <span class="string">"log_consumer"</span>);</span><br><span class="line">        <span class="comment">// kafka 消息的key序列化器</span></span><br><span class="line">        props.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="comment">// kafka 消息的value序列化器</span></span><br><span class="line">        props.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        props.put(<span class="string">"auto.offset.reset"</span>, <span class="string">"earliest"</span>);</span><br><span class="line"></span><br><span class="line">        FlinkKafkaConsumer&lt;String&gt; kafkaConsumer = <span class="keyword">new</span> FlinkKafkaConsumer&lt;String&gt;(</span><br><span class="line">                <span class="string">"user_access_logs"</span>,</span><br><span class="line">                <span class="keyword">new</span> SimpleStringSchema(),</span><br><span class="line">                props);</span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;String&gt; logSource = senv.addSource(kafkaConsumer);</span><br><span class="line">        <span class="comment">// 获取有效的日志数据</span></span><br><span class="line">        DataStream&lt;AccessLogRecord&gt; availableAccessLog = LogAnalysis.getAvailableAccessLog(logSource);</span><br><span class="line">        <span class="comment">// 获取[clienIP,accessDate,sectionId,articleId]</span></span><br><span class="line">        DataStream&lt;Tuple4&lt;String, String, Integer, Integer&gt;&gt; fieldFromLog = LogAnalysis.getFieldFromLog(availableAccessLog);</span><br><span class="line">        <span class="comment">//从DataStream中创建临时视图,名称为logs</span></span><br><span class="line">        <span class="comment">// 添加一个计算字段:proctime,用于维表JOIN</span></span><br><span class="line">        tEnv.createTemporaryView(<span class="string">"logs"</span>,</span><br><span class="line">                fieldFromLog,</span><br><span class="line">                $(<span class="string">"clientIP"</span>),</span><br><span class="line">                $(<span class="string">"accessDate"</span>),</span><br><span class="line">                $(<span class="string">"sectionId"</span>),</span><br><span class="line">                $(<span class="string">"articleId"</span>),</span><br><span class="line">                $(<span class="string">"proctime"</span>).proctime());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需求1：统计热门板块</span></span><br><span class="line">        LogAnalysis.getHotSection(tEnv);</span><br><span class="line">        <span class="comment">// 需求2：统计热门文章</span></span><br><span class="line">       LogAnalysis.getHotArticle(tEnv);</span><br><span class="line">        <span class="comment">// 需求3：统计不同客户端ip对版块和文章的总访问量</span></span><br><span class="line">       LogAnalysis.getClientAccess(tEnv);</span><br><span class="line">        senv.execute(<span class="string">"log-analysisi"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计不同客户端ip对版块和文章的总访问量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tEnv</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getClientAccess</span><span class="params">(StreamTableEnvironment tEnv)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// sink表</span></span><br><span class="line">        <span class="comment">// [client_ip,client_access_cnt,statistic_time]</span></span><br><span class="line">        <span class="comment">// [客户端ip,访问次数,统计时间]</span></span><br><span class="line">        String client_ip_access_ddl = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"CREATE TABLE client_ip_access (\n"</span> +</span><br><span class="line">                <span class="string">"    client_ip STRING ,\n"</span> +</span><br><span class="line">                <span class="string">"    client_access_cnt BIGINT,\n"</span> +</span><br><span class="line">                <span class="string">"    statistic_time STRING,\n"</span> +</span><br><span class="line">                <span class="string">"    PRIMARY KEY (client_ip) NOT ENFORCED\n"</span> +</span><br><span class="line">                <span class="string">")WITH (\n"</span> +</span><br><span class="line">                <span class="string">"    'connector' = 'jdbc',\n"</span> +</span><br><span class="line">                <span class="string">"    'url' = 'jdbc:mysql://kms-4:3306/statistics?useUnicode=true&amp;characterEncoding=utf-8',\n"</span> +</span><br><span class="line">                <span class="string">"    'table-name' = 'client_ip_access', \n"</span> +</span><br><span class="line">                <span class="string">"    'driver' = 'com.mysql.jdbc.Driver',\n"</span> +</span><br><span class="line">                <span class="string">"    'username' = 'root',\n"</span> +</span><br><span class="line">                <span class="string">"    'password' = '123qwe'\n"</span> +</span><br><span class="line">                <span class="string">") "</span>;</span><br><span class="line"></span><br><span class="line">        tEnv.executeSql(client_ip_access_ddl);</span><br><span class="line"></span><br><span class="line">        String client_ip_access_sql = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"INSERT INTO client_ip_access\n"</span> +</span><br><span class="line">                <span class="string">"SELECT\n"</span> +</span><br><span class="line">                <span class="string">"    clientIP,\n"</span> +</span><br><span class="line">                <span class="string">"    count(1) AS access_cnt,\n"</span> +</span><br><span class="line">                <span class="string">"    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS statistic_time\n"</span> +</span><br><span class="line">                <span class="string">"FROM\n"</span> +</span><br><span class="line">                <span class="string">"    logs \n"</span> +</span><br><span class="line">                <span class="string">"WHERE\n"</span> +</span><br><span class="line">                <span class="string">"    articleId &lt;&gt; 0 \n"</span> +</span><br><span class="line">                <span class="string">"    OR sectionId &lt;&gt; 0 \n"</span> +</span><br><span class="line">                <span class="string">"GROUP BY\n"</span> +</span><br><span class="line">                <span class="string">"    clientIP "</span></span><br><span class="line">               ;</span><br><span class="line">        tEnv.executeSql(client_ip_access_sql);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计热门文章</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tEnv</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getHotArticle</span><span class="params">(StreamTableEnvironment tEnv)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JDBC数据源</span></span><br><span class="line">        <span class="comment">// 文章id及标题对应关系的表,[tid, subject]分别为：文章id和标题</span></span><br><span class="line">        String pre_forum_post_ddl = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"CREATE TABLE pre_forum_post (\n"</span> +</span><br><span class="line">                <span class="string">"    tid INT,\n"</span> +</span><br><span class="line">                <span class="string">"    subject STRING,\n"</span> +</span><br><span class="line">                <span class="string">"    PRIMARY KEY (tid) NOT ENFORCED\n"</span> +</span><br><span class="line">                <span class="string">") WITH (\n"</span> +</span><br><span class="line">                <span class="string">"    'connector' = 'jdbc',\n"</span> +</span><br><span class="line">                <span class="string">"    'url' = 'jdbc:mysql://kms-4:3306/ultrax',\n"</span> +</span><br><span class="line">                <span class="string">"    'table-name' = 'pre_forum_post', \n"</span> +</span><br><span class="line">                <span class="string">"    'driver' = 'com.mysql.jdbc.Driver',\n"</span> +</span><br><span class="line">                <span class="string">"    'username' = 'root',\n"</span> +</span><br><span class="line">                <span class="string">"    'password' = '123qwe'\n"</span> +</span><br><span class="line">                <span class="string">")"</span>;</span><br><span class="line">        <span class="comment">// 创建pre_forum_post数据源</span></span><br><span class="line">        tEnv.executeSql(pre_forum_post_ddl);</span><br><span class="line">        <span class="comment">// 创建MySQL的sink表</span></span><br><span class="line">        <span class="comment">// [article_id,subject,article_pv,statistic_time]</span></span><br><span class="line">        <span class="comment">// [文章id,标题名称,访问次数,统计时间]</span></span><br><span class="line">        String hot_article_ddl = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"CREATE TABLE hot_article (\n"</span> +</span><br><span class="line">                <span class="string">"    article_id INT,\n"</span> +</span><br><span class="line">                <span class="string">"    subject STRING,\n"</span> +</span><br><span class="line">                <span class="string">"    article_pv BIGINT ,\n"</span> +</span><br><span class="line">                <span class="string">"    statistic_time STRING,\n"</span> +</span><br><span class="line">                <span class="string">"    PRIMARY KEY (article_id) NOT ENFORCED\n"</span> +</span><br><span class="line">                <span class="string">")WITH (\n"</span> +</span><br><span class="line">                <span class="string">"    'connector' = 'jdbc',\n"</span> +</span><br><span class="line">                <span class="string">"    'url' = 'jdbc:mysql://kms-4:3306/statistics?useUnicode=true&amp;characterEncoding=utf-8',\n"</span> +</span><br><span class="line">                <span class="string">"    'table-name' = 'hot_article', \n"</span> +</span><br><span class="line">                <span class="string">"    'driver' = 'com.mysql.jdbc.Driver',\n"</span> +</span><br><span class="line">                <span class="string">"    'username' = 'root',\n"</span> +</span><br><span class="line">                <span class="string">"    'password' = '123qwe'\n"</span> +</span><br><span class="line">                <span class="string">")"</span>;</span><br><span class="line">        tEnv.executeSql(hot_article_ddl);</span><br><span class="line">        <span class="comment">// 向MySQL目标表insert数据</span></span><br><span class="line">        String hot_article_sql = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"INSERT INTO hot_article\n"</span> +</span><br><span class="line">                <span class="string">"SELECT \n"</span> +</span><br><span class="line">                <span class="string">"    a.articleId,\n"</span> +</span><br><span class="line">                <span class="string">"    b.subject,\n"</span> +</span><br><span class="line">                <span class="string">"    count(1) as article_pv,\n"</span> +</span><br><span class="line">                <span class="string">"    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS statistic_time\n"</span> +</span><br><span class="line">                <span class="string">"FROM logs a \n"</span> +</span><br><span class="line">                <span class="string">"  JOIN pre_forum_post FOR SYSTEM_TIME AS OF a.proctime as b ON a.articleId = b.tid\n"</span> +</span><br><span class="line">                <span class="string">"WHERE a.articleId &lt;&gt; 0\n"</span> +</span><br><span class="line">                <span class="string">"GROUP BY a.articleId,b.subject\n"</span> +</span><br><span class="line">                <span class="string">"ORDER BY count(1) desc\n"</span> +</span><br><span class="line">                <span class="string">"LIMIT 10"</span>;</span><br><span class="line"></span><br><span class="line">        tEnv.executeSql(hot_article_sql);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计热门板块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tEnv</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getHotSection</span><span class="params">(StreamTableEnvironment tEnv)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 板块id及其名称对应关系表,[fid, name]分别为：版块id和板块名称</span></span><br><span class="line">        String pre_forum_forum_ddl = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"CREATE TABLE pre_forum_forum (\n"</span> +</span><br><span class="line">                <span class="string">"    fid INT,\n"</span> +</span><br><span class="line">                <span class="string">"    name STRING,\n"</span> +</span><br><span class="line">                <span class="string">"    PRIMARY KEY (fid) NOT ENFORCED\n"</span> +</span><br><span class="line">                <span class="string">") WITH (\n"</span> +</span><br><span class="line">                <span class="string">"    'connector' = 'jdbc',\n"</span> +</span><br><span class="line">                <span class="string">"    'url' = 'jdbc:mysql://kms-4:3306/ultrax',\n"</span> +</span><br><span class="line">                <span class="string">"    'table-name' = 'pre_forum_forum', \n"</span> +</span><br><span class="line">                <span class="string">"    'driver' = 'com.mysql.jdbc.Driver',\n"</span> +</span><br><span class="line">                <span class="string">"    'username' = 'root',\n"</span> +</span><br><span class="line">                <span class="string">"    'password' = '123qwe',\n"</span> +</span><br><span class="line">                <span class="string">"    'lookup.cache.ttl' = '10',\n"</span> +</span><br><span class="line">                <span class="string">"    'lookup.cache.max-rows' = '1000'"</span> +</span><br><span class="line">                <span class="string">")"</span>;</span><br><span class="line">        <span class="comment">// 创建pre_forum_forum数据源</span></span><br><span class="line">        tEnv.executeSql(pre_forum_forum_ddl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建MySQL的sink表</span></span><br><span class="line">        <span class="comment">// [section_id,name,section_pv,statistic_time]</span></span><br><span class="line">        <span class="comment">// [板块id,板块名称,访问次数,统计时间]</span></span><br><span class="line">        String hot_section_ddl = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"CREATE TABLE hot_section (\n"</span> +</span><br><span class="line">                <span class="string">"    section_id INT,\n"</span> +</span><br><span class="line">                <span class="string">"    name STRING ,\n"</span> +</span><br><span class="line">                <span class="string">"    section_pv BIGINT,\n"</span> +</span><br><span class="line">                <span class="string">"    statistic_time STRING,\n"</span> +</span><br><span class="line">                <span class="string">"    PRIMARY KEY (section_id) NOT ENFORCED  \n"</span> +</span><br><span class="line">                <span class="string">") WITH (\n"</span> +</span><br><span class="line">                <span class="string">"    'connector' = 'jdbc',\n"</span> +</span><br><span class="line">                <span class="string">"    'url' = 'jdbc:mysql://kms-4:3306/statistics?useUnicode=true&amp;characterEncoding=utf-8',\n"</span> +</span><br><span class="line">                <span class="string">"    'table-name' = 'hot_section', \n"</span> +</span><br><span class="line">                <span class="string">"    'driver' = 'com.mysql.jdbc.Driver',\n"</span> +</span><br><span class="line">                <span class="string">"    'username' = 'root',\n"</span> +</span><br><span class="line">                <span class="string">"    'password' = '123qwe'\n"</span> +</span><br><span class="line">                <span class="string">")"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建sink表:hot_section</span></span><br><span class="line">        tEnv.executeSql(hot_section_ddl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//统计热门板块</span></span><br><span class="line">        <span class="comment">// 使用日志流与MySQL的维表数据进行JOIN</span></span><br><span class="line">        <span class="comment">// 从而获取板块名称</span></span><br><span class="line">        String hot_section_sql = <span class="string">""</span> +</span><br><span class="line">                <span class="string">"INSERT INTO hot_section\n"</span> +</span><br><span class="line">                <span class="string">"SELECT\n"</span> +</span><br><span class="line">                <span class="string">"    a.sectionId,\n"</span> +</span><br><span class="line">                <span class="string">"    b.name,\n"</span> +</span><br><span class="line">                <span class="string">"    count(1) as section_pv,\n"</span> +</span><br><span class="line">                <span class="string">"    FROM_UNIXTIME(UNIX_TIMESTAMP()) AS statistic_time \n"</span> +</span><br><span class="line">                <span class="string">"FROM\n"</span> +</span><br><span class="line">                <span class="string">"    logs a\n"</span> +</span><br><span class="line">                <span class="string">"    JOIN pre_forum_forum FOR SYSTEM_TIME AS OF a.proctime as b ON a.sectionId = b.fid \n"</span> +</span><br><span class="line">                <span class="string">"WHERE\n"</span> +</span><br><span class="line">                <span class="string">"    a.sectionId &lt;&gt; 0 \n"</span> +</span><br><span class="line">                <span class="string">"GROUP BY a.sectionId, b.name\n"</span> +</span><br><span class="line">                <span class="string">"ORDER BY count(1) desc\n"</span> +</span><br><span class="line">                <span class="string">"LIMIT 10"</span>;</span><br><span class="line">        <span class="comment">// 执行数据insert</span></span><br><span class="line">        tEnv.executeSql(hot_section_sql);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取[clienIP,accessDate,sectionId,articleId]</span></span><br><span class="line"><span class="comment">     * 分别为客户端ip,访问日期,板块id,文章id</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logRecord</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DataStream&lt;Tuple4&lt;String, String, Integer, Integer&gt;&gt; getFieldFromLog(DataStream&lt;AccessLogRecord&gt; logRecord) &#123;</span><br><span class="line">        DataStream&lt;Tuple4&lt;String, String, Integer, Integer&gt;&gt; fieldFromLog = logRecord.map(<span class="keyword">new</span> MapFunction&lt;AccessLogRecord, Tuple4&lt;String, String, Integer, Integer&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Tuple4&lt;String, String, Integer, Integer&gt; <span class="title">map</span><span class="params">(AccessLogRecord accessLogRecord)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                LogParse parse = <span class="keyword">new</span> LogParse();</span><br><span class="line"></span><br><span class="line">                String clientIpAddress = accessLogRecord.getClientIpAddress();</span><br><span class="line">                String dateTime = accessLogRecord.getDateTime();</span><br><span class="line">                String request = accessLogRecord.getRequest();</span><br><span class="line">                String formatDate = parse.parseDateField(dateTime);</span><br><span class="line">                Tuple2&lt;String, String&gt; sectionIdAndArticleId = parse.parseSectionIdAndArticleId(request);</span><br><span class="line">                <span class="keyword">if</span> (formatDate == <span class="string">""</span> || sectionIdAndArticleId == Tuple2.of(<span class="string">""</span>, <span class="string">""</span>)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Tuple4&lt;String, String, Integer, Integer&gt;(<span class="string">"0.0.0.0"</span>, <span class="string">"0000-00-00 00:00:00"</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                Integer sectionId = (sectionIdAndArticleId.f0 == <span class="string">""</span>) ? <span class="number">0</span> : Integer.parseInt(sectionIdAndArticleId.f0);</span><br><span class="line">                Integer articleId = (sectionIdAndArticleId.f1 == <span class="string">""</span>) ? <span class="number">0</span> : Integer.parseInt(sectionIdAndArticleId.f1);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Tuple4&lt;&gt;(clientIpAddress, formatDate, sectionId, articleId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> fieldFromLog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 筛选可用的日志记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> accessLog</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DataStream&lt;AccessLogRecord&gt; <span class="title">getAvailableAccessLog</span><span class="params">(DataStream&lt;String&gt; accessLog)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> LogParse logParse = <span class="keyword">new</span> LogParse();</span><br><span class="line">        <span class="comment">//解析原始日志，将其解析为AccessLogRecord格式</span></span><br><span class="line">        DataStream&lt;AccessLogRecord&gt; filterDS = accessLog.map(<span class="keyword">new</span> MapFunction&lt;String, AccessLogRecord&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> AccessLogRecord <span class="title">map</span><span class="params">(String log)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> logParse.parseRecord(log);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).filter(<span class="keyword">new</span> FilterFunction&lt;AccessLogRecord&gt;() &#123;</span><br><span class="line">            <span class="comment">//过滤掉无效日志</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(AccessLogRecord accessLogRecord)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> !(accessLogRecord == <span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).filter(<span class="keyword">new</span> FilterFunction&lt;AccessLogRecord&gt;() &#123;</span><br><span class="line">            <span class="comment">//过滤掉状态码非200的记录，即保留请求成功的日志记录</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(AccessLogRecord accessLogRecord)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> !accessLogRecord.getHttpStatusCode().equals(<span class="string">"200"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> filterDS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将上述代码打包上传到集群运行，在执行提交命令之前，需要先将Hadoop的依赖jar包放置在Flink安装目录下的lib文件下：<strong>flink-shaded-hadoop-2-uber-2.7.5-10.0.jar</strong>，因为我们配置了HDFS上的状态后端，而Flink的release包不含有Hadoop的依赖Jar包。</p>
<p><img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/jar%E5%8C%85.png" alt></p>
<p>否则会报如下错误：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Caused by: org.apache.flink.core.fs.UnsupportedFileSystemSchemeException: Hadoop is not <span class="keyword">in</span> the classpath/dependencies.</span><br></pre></td></tr></table></figure>

<h3 id="提交到集群"><a href="#提交到集群" class="headerlink" title="提交到集群"></a>提交到集群</h3><p>编写提交命令脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/opt/modules/flink-1.11.1/bin/flink run -m kms-1:8081 \</span><br><span class="line">-c com.jmx.analysis.LogAnalysis \</span><br><span class="line">/opt/softwares/com.jmx-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<p>提交之后，访问Flink的Web界面，查看任务：</p>
<p><img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/FlinkWEB.png" alt></p>
<p>此时访问论坛，点击板块和帖子文章，观察数据库变化：</p>
<p><img src="//jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/%E7%BB%93%E6%9E%9C.png" alt></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要分享了从0到1构建一个用户行为日志分析系统。首先，基于discuz搭建了论坛平台，针对论坛产生的日志，使用Flume进行收集并push到Kafka中；接着使用Flink对其进行分析处理；最后将处理结果写入MySQL供可视化展示使用。</p>
<blockquote>
<p>公众号『大数据技术与数仓』，回复『资料』领取大数据资料包</p>
</blockquote>
</div><div class="recommended_posts"><h3>相关推荐 ☟</h3><li><a href="https://jiamaoxiang.top/2020/09/07/Hive-SQL使用过程中的奇怪现象/" target="_blank">Hive SQL使用过程中的奇怪现象</a></li><li><a href="https://jiamaoxiang.top/2020/09/07/使用Hive-SQL的窗口函数进行商务数据分析/" target="_blank">使用Hive SQL的窗口函数进行商务数据分析</a></li><li><a href="https://jiamaoxiang.top/2020/08/20/元数据管理-Hive-Hooks和Metastore监听器介绍/" target="_blank">元数据管理|Hive Hooks和Metastore监听器介绍</a></li><li><a href="https://jiamaoxiang.top/2020/08/19/SQL查询的执行顺序分析/" target="_blank">SQL查询的执行顺序分析</a></li></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Jia MaoXiang</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/">https://jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为博主原创文章，遵循CC BY-SA 4.0版权协议，转载请附上原文出处链接和本声明</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://jiamaoxiang.top/2020/08/29/项目实践-基于Flink的用户行为日志分析系统/" data-id="ckiye96o5007jbo7q4t5n15bi" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADMUlEQVR42u3awW4iQQwE0Pz/T7NSTitFkCp7kJjOm1NEEPTrHByX/fUVP4/v5+cr/7+e/5y/knzOz7Nd9mBjY2PfhP14+exJ+bckn5Of4ZerwcbGxj6O/bpovS4Sm0JSHLS8gl+M2NjY2H+S/fqdSVPRvjO5YmxsbGzstoDlR0+KX3KGTdOCjY2N/XfY7y4w+fvb97w9S8PGxsb+eHY76P3kn98438bGxsb+SPZj9LSDhHaQ3C761OfHxsbGPog9G9O+jng2IdHsEtuACRsbG/skdh4kzUL5fNVm1mzkw4OnpQsbGxv75uzNKsz71mvy3+Z/mKIaY2NjY9+KPVuIyWOjWTz0vm/HxsbGPo/dDnfbo+SAqz6zXTDCxsbGPoM9jGPi//DzyKkdBuTtx9NEDRsbG/sgdh7Hb1Zq2sKZl7f6OrCxsbGPYCcHzaOivJnJm5/N0Pfpt2NjY2MfxG5bgs1QNg+q8t8m7Kh8YmNjY9+WnQ8Arnr/rBfIY6akjcHGxsY+id02CRtqgrx22PxLccXGxsY+lD0rDO0AuC2E7UA3iqKwsbGxj2BvisdVF9QC8qJbJ2fY2NjYt2XPQva8wOTTic0lFoNqbGxs7IPY+UJMzsvHxlct6LRXj42NjX0qe1Oo8sagHfduhgTFdhI2Njb2bdnJR2/ahjbDycteC37agWFjY2MfwW4P0cY3+ZpOe9HDAQM2Njb2Qew8SCpi90UANIuQ2pNjY2Njn8S+KuJvx7p5McsDpqIpwsbGxj6IvTlKi9yPitvzRCfExsbGPoi9WabJi1DeTuRRUTvMwMbGxj6VPRvWzkKo9jPzlZ22QGJjY2OfxJ5FNvllbRZu8qFC2w5hY2Njn8TeFJsZaTNgmDUzdZaGjY2N/fHsR/nkEVJeDvPGpt5FevYt2NjY2AexZ8VgNl7N13fagppfJTY2Nvap7FmU3y76zGas+9al3lHCxsbGvi07KVqb4Wse+s8Gz8NlHWxsbGzs0SFmF3RV7IWNjY39l9kb/KZR2S/6rFoRbGxs7Juw86/JQ/9Z/NRSk0KLjY2NfTZ7Fc3EDUxb/PLGI4+6VvNtbGxs7E9k/wNnlUUoMs8oFAAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/Flink/">Flink</a></div><div class="post-nav"><a class="pre" href="/2020/09/07/使用Hive-SQL的窗口函数进行商务数据分析/">使用Hive SQL的窗口函数进行商务数据分析</a><a class="next" href="/2020/08/20/元数据管理-Hive-Hooks和Metastore监听器介绍/">元数据管理|Hive Hooks和Metastore监听器介绍</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-list-ul"> 目录</i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目简介"><span class="toc-number">1.</span> <span class="toc-text">项目简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于discuz搭建一个论坛平台"><span class="toc-number">2.</span> <span class="toc-text">基于discuz搭建一个论坛平台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装XAMPP"><span class="toc-number">2.1.</span> <span class="toc-text">安装XAMPP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Discuz"><span class="toc-number">2.2.</span> <span class="toc-text">安装Discuz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Discuz基本操作"><span class="toc-number">2.3.</span> <span class="toc-text">Discuz基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Discuz帖子-版块存储数据库表介"><span class="toc-number">2.4.</span> <span class="toc-text">Discuz帖子/版块存储数据库表介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改日志格式"><span class="toc-number">2.5.</span> <span class="toc-text">修改日志格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Apache日志格式介绍"><span class="toc-number">2.6.</span> <span class="toc-text">Apache日志格式介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Flume与Kafka集成"><span class="toc-number">3.</span> <span class="toc-text">Flume与Kafka集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动Flume-Agent"><span class="toc-number">3.1.</span> <span class="toc-text">启动Flume Agent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看push到Kafka的日志数据"><span class="toc-number">3.2.</span> <span class="toc-text">查看push到Kafka的日志数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#日志分析处理流程"><span class="toc-number">4.</span> <span class="toc-text">日志分析处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建MySQL数据库和目标表"><span class="toc-number">4.1.</span> <span class="toc-text">创建MySQL数据库和目标表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AccessLogRecord类"><span class="toc-number">4.2.</span> <span class="toc-text">AccessLogRecord类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LogParse类"><span class="toc-number">4.3.</span> <span class="toc-text">LogParse类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LogAnalysis类"><span class="toc-number">4.4.</span> <span class="toc-text">LogAnalysis类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#提交到集群"><span class="toc-number">4.5.</span> <span class="toc-text">提交到集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 - 2020 <a href="/." rel="nofollow">Jmx's Blog.</a>All rights reserved.<br>Thoughts on technology, life and everything else.</div></div></div><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.5" zindex="0.7" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>