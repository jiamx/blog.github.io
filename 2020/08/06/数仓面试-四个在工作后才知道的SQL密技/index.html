<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录朴实无华且枯燥的生活"><title>数仓面试|四个在工作后才知道的SQL密技 | Jmx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '912b6cfc43243cd27aeb428f7dbf7823';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">数仓面试|四个在工作后才知道的SQL密技</h1><a id="logo" href="/.">Jmx's Blog</a><p class="description">Keep it Simple and Stupid!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-pied-piper-alt"> 关于</i></a><a href="/tags"><i class="fa fa-tags"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">数仓面试|四个在工作后才知道的SQL密技</h1><div class="post-meta">Aug 6, 2020<span> | </span><span class="category"><a href="/categories/数仓/">数仓</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 13</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><a id="more"></a>

<p>SQL是大数据从业者的必备技能，大部分的大数据技术框架也都提供了SQL的解决方案。可以说SQL是一种经久不衰、历久弥新的编程语言。尤其是在数仓领域，使用SQL更是家常便饭。本文会分享四个在面试和工作中常用的几个使用技巧，具体包括：</p>
<ul>
<li>日期与期间的使用</li>
<li>临时表与Common Table Expression (WITH)</li>
<li>Aggregation 与CASE WHEN的结合使用</li>
<li>Window Function的其他用途</li>
</ul>
<blockquote>
<p>数仓？不就是写写SQL吗… <img src="//jiamaoxiang.top/2020/08/06/数仓面试-四个在工作后才知道的SQL密技/0.jpg" alt="img"></p>
</blockquote>
<h2 id="第一：日期与期间的使用"><a href="#第一：日期与期间的使用" class="headerlink" title="第一：日期与期间的使用"></a>第一：日期与期间的使用</h2><p>日期与时间段的筛选在工作中是经常被用到的，因为在拉取报表、仪表板和各种分析时，周、月、季度、年度的表现往往是分析需要考量的重点。</p>
<h3 id="时间区段的提取：Extract"><a href="#时间区段的提取：Extract" class="headerlink" title="时间区段的提取：Extract"></a>时间区段的提取：Extract</h3><ul>
<li>语法</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- field可以是day、hour、minute, month, quarter等等</span></span><br><span class="line"><span class="comment">-- source可以是date、timestamp类型</span></span><br><span class="line">extract(field FROM source)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 2020</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">quarter</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 3</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">month</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 8</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">week</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 31,一年中的第几周</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">day</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);  <span class="comment">-- 结果为 5</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">hour</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 9</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">minute</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 30</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">second</span> <span class="keyword">FROM</span> <span class="string">'2020-08-05 09:30:08'</span>);   <span class="comment">-- 结果为 8</span></span><br></pre></td></tr></table></figure>

<p>上面可供提取的字段，不同的数据库存在些许的差异。以Hive为例，支持<code>day, dayofweek, hour, minute, month, quarter, second, week 和 year</code>。其中周、月、年使用最为广泛，因为无论是公司内部产品，还是商用的产品所提供的数据后台统计，周报和月报(比如近7天、近30天)最注重表现的周期。</p>
<blockquote>
<p>注意：</p>
<p>impala支持：YEAR, QUARTER, MONTH, DAY, HOUR, MINUTE, SECOND, MILLISECOND, EPOCH</p>
<p>Hive支持：day, dayofweek, hour, minute, month, quarter, second, week 和 year</p>
<p>Hive是从<strong>Hive2.2.0</strong>版本开始引入该函数</p>
</blockquote>
<h3 id="周的提取"><a href="#周的提取" class="headerlink" title="周的提取"></a>周的提取</h3><ul>
<li>语法</li>
</ul>
<p>在按照周的区间进行统计时，需要识别出周一的日期与周日的日期，这个时候经常会用到下面的函数：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">next_day(STRING start_date, STRING day_of_week)</span><br><span class="line"><span class="comment">-- 返回当前日期对应的下一个周几对应的日期</span></span><br><span class="line"><span class="comment">-- 2020-08-05为周三</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'MO'</span>) <span class="comment">-- 下一个周一对应的日期：2020-08-10</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'TU'</span>) <span class="comment">-- 下一个周二对应的日期：2020-08-11</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'WE'</span>) <span class="comment">-- 下一个周三对应的日期：2020-08-12</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'TH'</span>) <span class="comment">-- 下一个周四对应的日期：2020-08-06，即为本周四</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'FR'</span>) <span class="comment">-- 下一个周五对应的日期：2020-08-07，即为本周五</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'SA'</span>) <span class="comment">-- 下一个周六对应的日期：2020-08-08，即为本周六</span></span><br><span class="line"><span class="keyword">SELECT</span> next_day(<span class="string">'2020-08-05'</span>,<span class="string">'SU'</span>) <span class="comment">-- 下一个周日对应的日期：2020-08-09，即为本周日</span></span><br><span class="line"><span class="comment">-- 星期一到星期日的英文（Monday，Tuesday、Wednesday、Thursday、Friday、Saturday、Sunday）</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用</li>
</ul>
<p>那么该如何获取当前日期所在周的周一对应的日期呢？只需要先获取当前日期的下周一对应的日期，然后减去7天，即可获得：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">date_add</span>(next_day(<span class="string">'2020-08-05'</span>,<span class="string">'MO'</span>),<span class="number">-7</span>);</span><br></pre></td></tr></table></figure>

<p>同理，获取当前日期所在周的周日对应的日期，只需要先获取当前日期的下周一对应的日期，然后减去1天，即可获得：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">date_add</span>(next_day(<span class="string">'2020-08-05'</span>,<span class="string">'MO'</span>),<span class="number">-1</span>) </span><br><span class="line"><span class="comment">-- 2020-08-09</span></span><br></pre></td></tr></table></figure>

<h3 id="月的提取"><a href="#月的提取" class="headerlink" title="月的提取"></a>月的提取</h3><ul>
<li>语法</li>
</ul>
<p>至于怎么将月份从单一日期提取出来呢，LAST_DAY这个函数可以将每个月中的日期变成该月的最后一天(28号，29号，30号或31号)，如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">last_day(STRING date)</span><br></pre></td></tr></table></figure>

<ul>
<li>使用</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">last_day</span>(<span class="string">'2020-08-05'</span>); <span class="comment">-- 2020-08-31</span></span><br></pre></td></tr></table></figure>

<p>除了上面的方式，也可以使用date_format函数，比如：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">date_format</span>(<span class="string">'2020-08-05'</span>,<span class="string">'yyyy-MM'</span>);</span><br><span class="line"><span class="comment">-- 2020-08</span></span><br></pre></td></tr></table></figure>

<h3 id="日期的范围"><a href="#日期的范围" class="headerlink" title="日期的范围"></a>日期的范围</h3><p>月的Window：使用add_months加上trunc()的应用</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 返回加减月份之后对应的日期</span></span><br><span class="line"><span class="comment">-- 2020-07-05</span></span><br><span class="line"><span class="keyword">select</span> add_months(<span class="string">'2020-08-05'</span>, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 返回当前日期的月初日期</span></span><br><span class="line"><span class="comment">-- 2020-08-01</span></span><br><span class="line"><span class="keyword">select</span> trunc(<span class="string">"2020-08-05"</span>,<span class="string">'MM'</span>)</span><br></pre></td></tr></table></figure>

<p>由上面范例可见，单纯使用add_months，减N个月的用法，可以刚好取到整数月的数据，但如果加上trunc()函数，则会从前N个月的一号开始取值。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 选取2020-07-05到2020-08-05所有数据</span></span><br><span class="line">BETWEEN add_months('2020-08-05', -1) AND '2020-08-05' </span><br><span class="line"><span class="comment">-- 选取2020-07-01到2020-08-05之间所有数据</span></span><br><span class="line">BETWEEN add_months(trunc("2020-08-05",'MM'),-1) AND '2020-08-05'</span><br></pre></td></tr></table></figure>

<h2 id="第二：临时表与Common-Table-Expression-WITH"><a href="#第二：临时表与Common-Table-Expression-WITH" class="headerlink" title="第二：临时表与Common Table Expression (WITH)"></a>第二：临时表与Common Table Expression (WITH)</h2><p>这两种方法是日常工作中经常被使用到，对于一些比较复杂的计算任务，为了避免过多的JOIN，通常会先把一些需要提取的部分数据使用临时表或是CTE的形式在主要查询区块前进行提取。</p>
<p><strong>临时表的作法：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE table_1 AS  </span><br><span class="line">    SELECT </span><br><span class="line">        columns</span><br><span class="line">    FROM table A;</span><br><span class="line">CREATE TEMPORARY table_2 AS </span><br><span class="line">    SELECT</span><br><span class="line">        columns</span><br><span class="line">    FROM table B;</span><br><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">    table_1.columns,</span><br><span class="line">    table_2.columns, </span><br><span class="line">    c.columns </span><br><span class="line">FROM table C JOIN table_1</span><br><span class="line">     JOIN table_2;</span><br></pre></td></tr></table></figure>

<p><strong>CTE的作法：</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-- 注意Hive、Impala支持这种语法，低版本的MySQL不支持(高版本支持)</span><br><span class="line">WITH employee_by_title_count AS (</span><br><span class="line">    SELECT</span><br><span class="line">        t.name as job_title</span><br><span class="line">        , COUNT(e.id) as amount_of_employees</span><br><span class="line">    FROM employees e</span><br><span class="line">        JOIN job_titles t on e.job_title_id = t.id</span><br><span class="line">    GROUP BY 1</span><br><span class="line">),</span><br><span class="line">salaries_by_title AS (</span><br><span class="line">     SELECT</span><br><span class="line">         name as job_title</span><br><span class="line">         , salary</span><br><span class="line">     FROM job_titles</span><br><span class="line">)</span><br><span class="line">SELECT *</span><br><span class="line">FROM employee_by_title_count e</span><br><span class="line">    JOIN salaries_by_title s ON s.job_title = e.job_title</span><br></pre></td></tr></table></figure>

<p>可以看到TEMP TABLE和CTE WITH的用法其实非常类似，目的都是为了让你的Query更加一目了然且优雅简洁。很多人习惯将所有的Query写在单一的区块里面，用过多的JOIN或SUBQUERY，导致最后逻辑丢失且自己也搞不清楚写到哪里，适时的使用TEMP TABLE和CTE作为辅助，绝对是很加分的。</p>
<h2 id="第三：Aggregation-与CASE-WHEN的结合使用"><a href="#第三：Aggregation-与CASE-WHEN的结合使用" class="headerlink" title="第三：Aggregation 与CASE WHEN的结合使用"></a>第三：Aggregation 与CASE WHEN的结合使用</h2><p>将Aggregation function (SUM/COUNT/COUNT DISTINCT/MIN/MAX) 结合CASE WHEN是最强大且最有趣的使用方式。这样的使用创造出一种类似EXCEL中SUMIF/COUNTIF的效果，可以用这个方式做出很多高效的分析。</p>
<ul>
<li>Table Name: order</li>
<li>Column: register_date, order_date, user_id, country, order_sales, order_id</li>
</ul>
<h3 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">order</span>(</span><br><span class="line">    register_date <span class="keyword">string</span>,</span><br><span class="line">    order_date <span class="keyword">string</span>,</span><br><span class="line">    user_id <span class="keyword">string</span>,</span><br><span class="line">    country <span class="keyword">string</span>,</span><br><span class="line">    order_sales <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">    order_id <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-07"</span>,<span class="string">"2020-06-09"</span>,<span class="string">"001"</span>,<span class="string">'c0'</span>,<span class="number">210</span>,<span class="string">"o1"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-08"</span>,<span class="string">"2020-06-09"</span>,<span class="string">"002"</span>,<span class="string">'c1'</span>,<span class="number">220</span>,<span class="string">"o2"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-07"</span>,<span class="string">"2020-06-10"</span>,<span class="string">"003"</span>,<span class="string">'c2'</span>,<span class="number">230</span>,<span class="string">"o3"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-09"</span>,<span class="string">"2020-06-10"</span>,<span class="string">"004"</span>,<span class="string">'c3'</span>,<span class="number">200</span>,<span class="string">"o4"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-07"</span>,<span class="string">"2020-06-20"</span>,<span class="string">"005"</span>,<span class="string">'c4'</span>,<span class="number">300</span>,<span class="string">"o5"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-10"</span>,<span class="string">"2020-06-23"</span>,<span class="string">"006"</span>,<span class="string">'c5'</span>,<span class="number">400</span>,<span class="string">"o6"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-07"</span>,<span class="string">"2020-06-19"</span>,<span class="string">"007"</span>,<span class="string">'c6'</span>,<span class="number">600</span>,<span class="string">"o7"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-12"</span>,<span class="string">"2020-06-18"</span>,<span class="string">"008"</span>,<span class="string">'c7'</span>,<span class="number">700</span>,<span class="string">"o8"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-07"</span>,<span class="string">"2020-06-09"</span>,<span class="string">"009"</span>,<span class="string">'c8'</span>,<span class="number">100</span>,<span class="string">"o9"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-15"</span>,<span class="string">"2020-06-18"</span>,<span class="string">"0010"</span>,<span class="string">'c9'</span>,<span class="number">200</span>,<span class="string">"o10"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-15"</span>,<span class="string">"2020-06-19"</span>,<span class="string">"0011"</span>,<span class="string">'c10'</span>,<span class="number">250</span>,<span class="string">"o11"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-12"</span>,<span class="string">"2020-06-29"</span>,<span class="string">"0012"</span>,<span class="string">'c11'</span>,<span class="number">270</span>,<span class="string">"o12"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-16"</span>,<span class="string">"2020-06-19"</span>,<span class="string">"0013"</span>,<span class="string">'c12'</span>,<span class="number">230</span>,<span class="string">"o13"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-17"</span>,<span class="string">"2020-06-20"</span>,<span class="string">"0014"</span>,<span class="string">'c13'</span>,<span class="number">290</span>,<span class="string">"o14"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> <span class="keyword">order</span> <span class="keyword">VALUES</span>(<span class="string">"2020-06-20"</span>,<span class="string">"2020-06-29"</span>,<span class="string">"0015"</span>,<span class="string">'c14'</span>,<span class="number">203</span>,<span class="string">"o15"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="CASE-WHEN-时间，进行留存率-使用率的分析"><a href="#CASE-WHEN-时间，进行留存率-使用率的分析" class="headerlink" title="CASE WHEN 时间，进行留存率/使用率的分析"></a>CASE WHEN 时间，进行留存率/使用率的分析</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 允许多列去重</span></span><br><span class="line"><span class="keyword">set</span> hive.groupby.skewindata = <span class="literal">false</span></span><br><span class="line"><span class="comment">-- 允许使用位置编号分组或排序</span></span><br><span class="line"><span class="keyword">set</span> hive.groupby.orderby.position.alias = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">date_add</span>(Next_day(register_date, <span class="string">'MO'</span>),<span class="number">-1</span>) <span class="keyword">AS</span> week_end,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> order_date <span class="keyword">BETWEEN</span> register_date <span class="keyword">AND</span> <span class="keyword">date_add</span>(register_date,<span class="number">6</span>) <span class="keyword">THEN</span> user_id <span class="keyword">END</span>) <span class="keyword">AS</span> first_week_order,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> order_date <span class="keyword">BETWEEN</span> <span class="keyword">date_add</span>(register_date ,<span class="number">7</span>) <span class="keyword">AND</span> <span class="keyword">date_add</span>(register_date,<span class="number">13</span>) <span class="keyword">THEN</span> user_id <span class="keyword">END</span>) <span class="keyword">AS</span> sencod_week_order,</span><br><span class="line">    <span class="keyword">COUNT</span>(<span class="keyword">DISTINCT</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> order_date <span class="keyword">BETWEEN</span> <span class="keyword">date_add</span>(register_date ,<span class="number">14</span>) <span class="keyword">AND</span> <span class="keyword">date_add</span>(register_date,<span class="number">20</span>) <span class="keyword">THEN</span> user_id <span class="keyword">END</span>) <span class="keyword">as</span> third_week_order</span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">order</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>上面的示例可以得知到用户在注册之后，有没有创建订单的行为。比如注册后的第一周，第二周，第三周分别有多少下单用户，这样可以分析出用户的使用情况和留存情况。</p>
<blockquote>
<p>注意：上面的使用方式，需要配置两个参数：</p>
<p><strong>hive.groupby.skewindata = false</strong>：允许多列去重，否则报错：</p>
<p><code>SemanticException [Error 10022]: DISTINCT on different columns not supported with skew in data</code></p>
<p><strong>hive.groupby.orderby.position.alias = true</strong>：允许使用位置编号分组或排序,否则报错：</p>
<p><code>SemanticException [Error 10025]: line 79:13 Expression not in GROUP BY key &#39;&#39;MO&#39;&#39;</code></p>
</blockquote>
<h3 id="CASE-WHEN-时间，进行每个用户消费金额的分析"><a href="#CASE-WHEN-时间，进行每个用户消费金额的分析" class="headerlink" title="CASE WHEN 时间，进行每个用户消费金额的分析"></a>CASE WHEN 时间，进行每个用户消费金额的分析</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    user_id,</span><br><span class="line">    SUM (CASE WHEN order_date BETWEEN register_date AND date_add(register_date,6) THEN order_sales END) AS first_week_amount,</span><br><span class="line">    SUM (CASE WHEN order_date BETWEEN date_add(register_date ,7) AND date_add(register_date,13) THEN order_sales END) AS second_week_amount</span><br><span class="line">    FROM order</span><br><span class="line">GROUP BY 1</span><br></pre></td></tr></table></figure>

<p>通过筛选出注册与消费的日期，并且进行消费金额统计，每个用户在每段时间段(注册后第一周、第二周…以此类推)的消费金额，可以观察用户是否有持续维持消费习惯或是消费金额变低等分析。</p>
<h3 id="CASE-WHEN数量，消费金额超过某一定额的数量分析"><a href="#CASE-WHEN数量，消费金额超过某一定额的数量分析" class="headerlink" title="CASE WHEN数量，消费金额超过某一定额的数量分析"></a>CASE WHEN数量，消费金额超过某一定额的数量分析</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    user_id,</span><br><span class="line">    COUNT(DISTINCT CASE WHEN order_sales &gt;= 100 THEN order_id END) AS count_of_order_greateer_than_100</span><br><span class="line">FROM order</span><br><span class="line">GROUP BY 1</span><br></pre></td></tr></table></figure>

<p>上面的示例就是类似countif的用法，针对每个用户，统计其订单金额大于某个值的订单数量，分析去筛选出高价值的顾客。</p>
<h3 id="CASE-WHEN数量，加上时间的用法"><a href="#CASE-WHEN数量，加上时间的用法" class="headerlink" title="CASE WHEN数量，加上时间的用法"></a>CASE WHEN数量，加上时间的用法</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">    user_id,</span><br><span class="line">    MIN(CASE WHEN order_sales &gt; 100 THEN order_date END) AS first_order_date_over1000,</span><br><span class="line">    MAX(CASE WHEN order_sales &gt; 100 THEN order_date END) AS recent_order_date_over100</span><br><span class="line">FROM order</span><br><span class="line">GROUP BY 1</span><br></pre></td></tr></table></figure>

<p>CASE WHEN加上MIN/MAX时间，可以得出该用户在其整个使用过程中，首次购买超过一定金额的订单日期，以及最近一次购买超过一定金额的订单日期。</p>
<h2 id="第四：Window-Function的其他用途"><a href="#第四：Window-Function的其他用途" class="headerlink" title="第四：Window Function的其他用途"></a>第四：Window Function的其他用途</h2><p>Window Function既是工作中经常使用的函数，也是面试时经常被问到的问题。常见的使用场景是分组取topN。本文介绍的另外一个用法，使用开窗函数进行用户访问session分析。</p>
<p>session是指在指定的时间段内用户在网站上发生的一系列互动。例如，一次session可以包含多个网页浏览、事件、社交互动和电子商务交易。session就相当于一个容器，其中包含了用户在网站上执行的操作。</p>
<p><img src="https://lh3.googleusercontent.com/jYib9rNgrLOavCGfEaMPqJNOIf6cN5aHqsZpXAKPP1IVOUM3iFImIIxMW_AnWHlI5xKJ=w550" alt="Many interactions can happen within one visit."></p>
<p>session具有一个过期时间，比如30分钟，即不活动状态超过 30 分钟，该session就会过时。</p>
<p>假设张三访问了网站，从他到达网站的那一刻开始，就开始计时。如果过了 30 分钟，而张三仍然没有进行任何形式的互动，则视为本次session结束。但是，只要张三与某个元素进行了互动（例如发生了某个事件、社交互动或打开了新网页），就会在该次互动的时间基础上再增加 30 分钟，从而重置过期时间。</p>
<p><img src="https://lh3.googleusercontent.com/e4JuWb2416rLY5bXu93-bBeDtWh3UH3UCymcVeFylmOLH_pNp-UX6amLQkrH4e9o2Q=w550" alt="A series of standard interactions and the visit expiry."></p>
<h3 id="数据准备-1"><a href="#数据准备-1" class="headerlink" title="数据准备"></a>数据准备</h3><ul>
<li>Table Name: user_visit_action</li>
<li>Columns: user_id, session_id , page_url, action_time</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_visit_action( </span><br><span class="line">    user_id <span class="keyword">string</span>,</span><br><span class="line">    session_id <span class="keyword">string</span>,</span><br><span class="line">    page_url <span class="keyword">string</span>,</span><br><span class="line">    action_time <span class="keyword">string</span>);</span><br><span class="line">    </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss001"</span>,<span class="string">"http://a.com"</span>,<span class="string">"2020-08-06 13:34:11.478"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss001"</span>,<span class="string">"http://b.com"</span>,<span class="string">"2020-08-06 13:35:11.478"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss001"</span>,<span class="string">"http://c.com"</span>,<span class="string">"2020-08-06 13:36:11.478"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss002"</span>,<span class="string">"http://a.com"</span>,<span class="string">"2020-08-06 14:30:11.478"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss002"</span>,<span class="string">"http://b.com"</span>,<span class="string">"2020-08-06 14:31:11.478"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss002"</span>,<span class="string">"http://e.com"</span>,<span class="string">"2020-08-06 14:33:11.478"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"001"</span>,<span class="string">"ss002"</span>,<span class="string">"http://f.com"</span>,<span class="string">"2020-08-06 14:35:11.478"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"002"</span>,<span class="string">"ss003"</span>,<span class="string">"http://u.com"</span>,<span class="string">"2020-08-06 18:34:11.478"</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> user_visit_action <span class="keyword">VALUES</span>(<span class="string">"002"</span>,<span class="string">"ss003"</span>,<span class="string">"http://k.com"</span>,<span class="string">"2020-08-06 18:38:11.478"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="用户访问session分析"><a href="#用户访问session分析" class="headerlink" title="用户访问session分析"></a>用户访问session分析</h3><p>范例的资料表如上，有使用者、访次和页面的连结和时间。以下则使用partition by来表达每个使用者在不同访次之间的浏览行为。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    session_id,</span><br><span class="line">    page_url,</span><br><span class="line">    <span class="keyword">DENSE_RANK</span>() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id, session_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> action_time <span class="keyword">ASC</span>) <span class="keyword">AS</span> page_order,</span><br><span class="line">    <span class="keyword">MIN</span>(action_time) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id, session_id) <span class="keyword">AS</span> session_start_time,</span><br><span class="line">    <span class="keyword">MAX</span>(action_time) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id, session_id) <span class="keyword">AS</span> session_finisht_time</span><br><span class="line"><span class="keyword">FROM</span> user_visit_action</span><br></pre></td></tr></table></figure>

<p>上面的查询会返回针对每个用户、每次的到访，浏览页面行为的先后次序，以及该session开始与结束的时间，以此为基础就可以将这个结果存入TEMP TABLE或是CTE ，进行更进一步的分析。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文主要分享了四个在工作和面试中经常遇到的SQL使用技巧。当然，这些都与具体的分析业务息息相关。最后，不管你是SQL boy  or  SQL girl，只要是掌握一些技巧，相信都能够Happy SQL querying 😊。</p>
</div><div class="recommended_posts"><h3>相关推荐 ☟</h3><li><a href="https://jiamaoxiang.top/2020/08/12/Flink1-11中的CDC-Connectors操作实践/" target="_blank">Flink1.11中的CDC Connectors操作实践</a></li><li><a href="https://jiamaoxiang.top/2020/08/07/一文搞懂HBase的基本原理/" target="_blank">内含面试|一文搞懂HBase的基本原理</a></li><li><a href="https://jiamaoxiang.top/2020/08/02/第七篇-Spark平台下基于LDA的k-means算法实现/" target="_blank">第七篇|Spark平台下基于LDA的k-means算法实现</a></li><li><a href="https://jiamaoxiang.top/2020/07/31/第六篇-Spark-MLLib机器学习/" target="_blank">第六篇|Spark MLLib机器学习(1)</a></li></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Jia MaoXiang</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/08/06/数仓面试-四个在工作后才知道的SQL密技/">https://jiamaoxiang.top/2020/08/06/数仓面试-四个在工作后才知道的SQL密技/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为博主原创文章，遵循CC BY-SA 4.0版权协议，转载请附上原文出处链接和本声明</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://jiamaoxiang.top/2020/08/06/数仓面试-四个在工作后才知道的SQL密技/" data-id="ckf14v7er003q5c7q04nxlghi" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADLElEQVR42u3aMW7DQAwEwPz/006bInZ2SRmwLqMqMCT55lLQXN7XV3w9flyv73n9efKG1/cn91x2YWNjY9+E/Xh5PVt6srjkW/b3P1vbs2exsbGxT2Unhef1nc8Wlxe/zabkFmxsbGzsWRvQNjPtNmFjY2Njt4t4BNcmDGrLHjY2NjZ20gy0nyQBUF6QZvdckKVhY2Njfzw7byQ+/++3zLexsbGxP5j9GF2z+CkfMyTNRl60flkPNjY29kHsWavQtjH7ktkeBooiJ2xsbOxD2Umx2YwKNqVxNmYY7is2Njb2Qez2qWTRbXOStzrFt2NjY2MfxJ7h24Xm9+QFMk/+sbGxsU9lJ1/WlrT9drQtR/4fxsbGxj6Pvf/Rnwc6s3Aqf8PwQA82Njb2cey2tGwGALMt3pSrPzowbGxs7BuyNwHNLKzfh03toDdqP7CxsbFvy25HtnnBSOKhWfNw2ZFQbGxs7CPYsxLVNh6zxuZ968HGxsY+iT0bFcyi+bzwvG/MjI2NjX0euw3x3xc8taOCzdEibGxs7JPYmyM1s3LVDnRn31tsBDY2NvbN2XnovxkDzO5sw6N8C7CxsbHPY9c/3xcHaDbhUfItUQODjY2NfRA7X0QbHs0Wujm4MxwSYGNjYx/BviBkj4cBSWDUfv4oL2xsbOyT2G25agvMps2YjY2j6AobGxv7IPZmiDsrRW113T9b1FtsbGzsI9jtAZrZotuyNxtmDDswbGxs7FuxZyF73lTkz85Gv+0BoNVsARsbG/sm7DbE2Rz3yZGzofLTVWFjY2MfxJ79xM+PzrRj4DZIWo0TsLGxsY9gt9FMe+xmP4q4amz8x3wbGxsb+7bstoDNov98EJsfuJltMTY2NvZ57NlRmFno38ZJeYFMtvWX/zM2Njb2Eew2PJq9+ire7G3Y2NjY/4HdRvCbaemsQG7GA0+3DBsbG/s4dhuyJyPV/GBNXoQuSNGwsbGx/zF7FhvlQ9zZ/fk4YVjAsLGxsQ9i52F98ub26E/ytvwpbGxs7PPYbajUHvSpl3XpCPmyLA0bGxv7I9l5QJNsU7LETVlK2pXVTBsbGxv7Tuxv/8WBpc4F6rcAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/数仓/">数仓</a></div><div class="post-nav"><a class="pre" href="/2020/08/07/一文搞懂HBase的基本原理/">内含面试|一文搞懂HBase的基本原理</a><a class="next" href="/2020/08/02/第七篇-Spark平台下基于LDA的k-means算法实现/">第七篇|Spark平台下基于LDA的k-means算法实现</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-list-ul"> 目录</i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#第一：日期与期间的使用"><span class="toc-number">1.</span> <span class="toc-text">第一：日期与期间的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#时间区段的提取：Extract"><span class="toc-number">1.1.</span> <span class="toc-text">时间区段的提取：Extract</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#周的提取"><span class="toc-number">1.2.</span> <span class="toc-text">周的提取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#月的提取"><span class="toc-number">1.3.</span> <span class="toc-text">月的提取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日期的范围"><span class="toc-number">1.4.</span> <span class="toc-text">日期的范围</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第二：临时表与Common-Table-Expression-WITH"><span class="toc-number">2.</span> <span class="toc-text">第二：临时表与Common Table Expression (WITH)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第三：Aggregation-与CASE-WHEN的结合使用"><span class="toc-number">3.</span> <span class="toc-text">第三：Aggregation 与CASE WHEN的结合使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据准备"><span class="toc-number">3.1.</span> <span class="toc-text">数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE-WHEN-时间，进行留存率-使用率的分析"><span class="toc-number">3.2.</span> <span class="toc-text">CASE WHEN 时间，进行留存率/使用率的分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE-WHEN-时间，进行每个用户消费金额的分析"><span class="toc-number">3.3.</span> <span class="toc-text">CASE WHEN 时间，进行每个用户消费金额的分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE-WHEN数量，消费金额超过某一定额的数量分析"><span class="toc-number">3.4.</span> <span class="toc-text">CASE WHEN数量，消费金额超过某一定额的数量分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CASE-WHEN数量，加上时间的用法"><span class="toc-number">3.5.</span> <span class="toc-text">CASE WHEN数量，加上时间的用法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第四：Window-Function的其他用途"><span class="toc-number">4.</span> <span class="toc-text">第四：Window Function的其他用途</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据准备-1"><span class="toc-number">4.1.</span> <span class="toc-text">数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#用户访问session分析"><span class="toc-number">4.2.</span> <span class="toc-text">用户访问session分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-number">5.</span> <span class="toc-text">小结</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 - 2020 <a href="/." rel="nofollow">Jmx's Blog.</a>All rights reserved.<br>Thoughts on technology, life and everything else.</div></div></div><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.5" zindex="0.7" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>