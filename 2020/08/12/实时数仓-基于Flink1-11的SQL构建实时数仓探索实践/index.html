<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录朴实无华且枯燥的生活"><title>实时数仓|基于Flink1.11的SQL构建实时数仓探索实践 | Jmx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '912b6cfc43243cd27aeb428f7dbf7823';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">实时数仓|基于Flink1.11的SQL构建实时数仓探索实践</h1><a id="logo" href="/.">Jmx's Blog</a><p class="description">Keep it Simple and Stupid!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-pied-piper-alt"> 关于</i></a><a href="/tags"><i class="fa fa-tags"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">实时数仓|基于Flink1.11的SQL构建实时数仓探索实践</h1><div class="post-meta">Aug 12, 2020<span> | </span><span class="category"><a href="/categories/实时数仓/">实时数仓</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 20</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><a id="more"></a>

<p>实时数仓主要是为了解决传统数仓数据时效性低的问题，实时数仓通常会用在实时的OLAP分析、实时的数据看板、业务指标实时监控等场景。虽然关于实时数仓的架构及技术选型与传统的离线数仓会存在差异，但是关于数仓建设的基本方法论是一致的。本文会分享基于Flink SQL从0到1搭建一个实时数仓的demo，涉及数据采集、存储、计算、可视化整个处理流程。通过本文你可以了解到：</p>
<ul>
<li>实时数仓的基本架构</li>
<li>实时数仓的数据处理流程</li>
<li>Flink1.11的SQL新特性</li>
<li>Flink1.11存在的bug</li>
<li>完整的操作案例</li>
</ul>
<blockquote>
<p>古人学问无遗力，少壮工夫老始成。</p>
<p>纸上得来终觉浅，绝知此事要躬行。</p>
</blockquote>
<h2 id="案例简介"><a href="#案例简介" class="headerlink" title="案例简介"></a>案例简介</h2><p>本文会以电商业务为例，展示实时数仓的数据处理流程。另外，本文旨在说明实时数仓的构建流程，所以不会涉及太复杂的数据计算。为了保证案例的可操作性和完整性，本文会给出详细的操作步骤。为了方便演示，本文的所有操作都是在Flink SQL Cli中完成的。</p>
<h2 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h2><p>具体的架构设计如图所示：首先通过canal解析MySQL的binlog日志，将数据存储在Kafka中。然后使用Flink SQL对原始数据进行清洗关联，并将处理之后的明细宽表写入kafka中。维表数据存储在MySQL中，通过Flink SQL对明细宽表与维表进行JOIN，将聚合后的数据写入MySQL，最后通过FineBI进行可视化展示。</p>
<img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/实时数仓架构.png" style="zoom:80%;">

<h2 id="业务数据准备"><a href="#业务数据准备" class="headerlink" title="业务数据准备"></a>业务数据准备</h2><ul>
<li>订单表（order_info）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`consignee`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收货人'</span>,</span><br><span class="line">  <span class="string">`consignee_tel`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'收件人电话'</span>,</span><br><span class="line">  <span class="string">`total_amount`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'总金额'</span>,</span><br><span class="line">  <span class="string">`order_status`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单状态'</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'用户id'</span>,</span><br><span class="line">  <span class="string">`payment_way`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'付款方式'</span>,</span><br><span class="line">  <span class="string">`delivery_address`</span> <span class="built_in">varchar</span>(<span class="number">1000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'送货地址'</span>,</span><br><span class="line">  <span class="string">`order_comment`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单备注'</span>,</span><br><span class="line">  <span class="string">`out_trade_no`</span> <span class="built_in">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单交易编号（第三方支付用)'</span>,</span><br><span class="line">  <span class="string">`trade_body`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单描述(第三方支付用)'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`operate_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'操作时间'</span>,</span><br><span class="line">  <span class="string">`expire_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'失效时间'</span>,</span><br><span class="line">  <span class="string">`tracking_no`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'物流单编号'</span>,</span><br><span class="line">  <span class="string">`parent_order_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'父订单编号'</span>,</span><br><span class="line">  <span class="string">`img_url`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片路径'</span>,</span><br><span class="line">  <span class="string">`province_id`</span> <span class="built_in">int</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'地区'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'订单表'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>订单详情表（order_detail）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`order_detail`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'订单编号'</span>,</span><br><span class="line">  <span class="string">`sku_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku_id'</span>,</span><br><span class="line">  <span class="string">`sku_name`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku名称（冗余)'</span>,</span><br><span class="line">  <span class="string">`img_url`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'图片名称（冗余)'</span>,</span><br><span class="line">  <span class="string">`order_price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买价格(下单时sku价格）'</span>,</span><br><span class="line">  <span class="string">`sku_num`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'购买个数'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'订单详情表'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>商品表（sku_info）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`sku_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'skuid(itemID)'</span>,</span><br><span class="line">  <span class="string">`spu_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'spuid'</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'价格'</span>,</span><br><span class="line">  <span class="string">`sku_name`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sku名称'</span>,</span><br><span class="line">  <span class="string">`sku_desc`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'商品规格描述'</span>,</span><br><span class="line">  <span class="string">`weight`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'重量'</span>,</span><br><span class="line">  <span class="string">`tm_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'品牌(冗余)'</span>,</span><br><span class="line">  <span class="string">`category3_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'三级分类id（冗余)'</span>,</span><br><span class="line">  <span class="string">`sku_default_img`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'默认显示图片(冗余)'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'商品表'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>商品一级类目表（base_category1）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_category1`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'分类名称'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'一级分类表'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>商品二级类目表（base_category2）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_category2`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'二级分类名称'</span>,</span><br><span class="line">  <span class="string">`category1_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'一级分类编号'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'二级分类表'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>商品三级类目表（base_category3）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_category3`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'编号'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'三级分类名称'</span>,</span><br><span class="line">  <span class="string">`category2_id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'二级分类编号'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'三级分类表'</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>省份表（base_province）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_province`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'id'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'省名称'</span>,</span><br><span class="line">  <span class="string">`region_id`</span> <span class="built_in">int</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'大区id'</span>,</span><br><span class="line">  <span class="string">`area_code`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'行政区位码'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<ul>
<li>区域表（base_region）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_region`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'大区id'</span>,</span><br><span class="line">  <span class="string">`region_name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'大区名称'</span>,</span><br><span class="line">   PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：以上的建表语句是在MySQL中完成的，完整的建表及模拟数据生成脚本见：</p>
<p>链接：<a href="https://pan.baidu.com/s/1fcMgDHGKedOpzqLbSRUGwA" target="_blank" rel="noopener">https://pan.baidu.com/s/1fcMgDHGKedOpzqLbSRUGwA</a> 提取码：zuqw</p>
</blockquote>
<h2 id="数据处理流程"><a href="#数据处理流程" class="headerlink" title="数据处理流程"></a>数据处理流程</h2><h3 id="ODS层数据同步"><a href="#ODS层数据同步" class="headerlink" title="ODS层数据同步"></a>ODS层数据同步</h3><p>关于ODS层的数据同步参见我的另一篇文章<a href="https://mp.weixin.qq.com/s/ooPAScXAw2soqlgEoSbRAw" target="_blank" rel="noopener">基于Canal与Flink实现数据实时增量同步(一)</a>。主要使用canal解析MySQL的binlog日志，然后将其写入到Kafka对应的topic中。由于篇幅限制，不会对具体的细节进行说明。同步之后的结果如下图所示：</p>
<p><img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/ods.png" alt></p>
<h3 id="DIM层维表数据准备"><a href="#DIM层维表数据准备" class="headerlink" title="DIM层维表数据准备"></a>DIM层维表数据准备</h3><p>本案例中将维表存储在了MySQL中，实际生产中会用HBase存储维表数据。我们主要用到两张维表：<strong>区域维表</strong>和<strong>商品维表</strong>。处理过程如下：</p>
<ul>
<li>区域维表</li>
</ul>
<p>首先将<code>mydw.base_province</code>和<code>mydw.base_region</code>这个主题对应的数据抽取到MySQL中，主要使用Flink SQL的Kafka数据源对应的canal-json格式，注意：在执行装载之前，需要先在MySQL中创建对应的表，本文使用的MySQL数据库的名字为<strong>dim</strong>，用于存放维表数据。如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   省份</span></span><br><span class="line"><span class="comment">--   kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_base_province`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_base_province`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`region_id`</span> <span class="built_in">INT</span> ,</span><br><span class="line">  <span class="string">`area_code`</span><span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.base_province'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   省份</span></span><br><span class="line"><span class="comment">--   MySQL Sink</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`base_province`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_province`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INT</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">    <span class="string">`region_id`</span> <span class="built_in">INT</span> ,</span><br><span class="line">    <span class="string">`area_code`</span><span class="keyword">STRING</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'base_province'</span>, <span class="comment">-- MySQL中的待插入数据的表</span></span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'sink.buffer-flush.interval'</span> = <span class="string">'1s'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   省份</span></span><br><span class="line"><span class="comment">--   MySQL Sink Load Data</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> base_province</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> ods_base_province;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   区域</span></span><br><span class="line"><span class="comment">--   kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_base_region`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_base_region`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INT</span>,</span><br><span class="line">  <span class="string">`region_name`</span> <span class="keyword">STRING</span></span><br><span class="line">) <span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.base_region'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   区域</span></span><br><span class="line"><span class="comment">--   MySQL Sink</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`base_region`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_region`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">INT</span>,</span><br><span class="line">    <span class="string">`region_name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">     PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'base_region'</span>, <span class="comment">-- MySQL中的待插入数据的表</span></span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'sink.buffer-flush.interval'</span> = <span class="string">'1s'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   区域</span></span><br><span class="line"><span class="comment">--   MySQL Sink Load Data</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> base_region</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> ods_base_region;</span><br></pre></td></tr></table></figure>

<p>经过上面的步骤，将创建维表所需要的原始数据已经存储到了MySQL中，接下来就需要在MySQL中创建维表，我们使用上面的两张表，创建一张视图：<code>dim_province</code>作为维表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- DIM层,区域维表,</span></span><br><span class="line"><span class="comment">-- 在MySQL中创建视图</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> dim_province;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> dim_province <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  bp.id <span class="keyword">AS</span> province_id,</span><br><span class="line">  bp.name <span class="keyword">AS</span> province_name,</span><br><span class="line">  br.id <span class="keyword">AS</span> region_id,</span><br><span class="line">  br.region_name <span class="keyword">AS</span> region_name,</span><br><span class="line">  bp.area_code <span class="keyword">AS</span> area_code</span><br><span class="line"><span class="keyword">FROM</span> base_region br </span><br><span class="line">     <span class="keyword">JOIN</span> base_province bp <span class="keyword">ON</span> br.id= bp.region_id</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>这样我们所需要的维表：dim_province就创建好了，只需要在维表join时，使用Flink SQL创建JDBC的数据源，就可以使用该维表了。同理，我们使用相同的方法创建商品维表，具体如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  一级类目表</span></span><br><span class="line"><span class="comment">--   kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_base_category1`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_base_category1`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="keyword">STRING</span></span><br><span class="line">)<span class="keyword">WITH</span>(</span><br><span class="line"> <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.base_category1'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  一级类目表</span></span><br><span class="line"><span class="comment">--   MySQL Sink</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`base_category1`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_category1`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">     PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'base_category1'</span>, <span class="comment">-- MySQL中的待插入数据的表</span></span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'sink.buffer-flush.interval'</span> = <span class="string">'1s'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  一级类目表</span></span><br><span class="line"><span class="comment">--   MySQL Sink Load Data</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> base_category1</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> ods_base_category1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  二级类目表</span></span><br><span class="line"><span class="comment">--   kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_base_category2`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_base_category2`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`category1_id`</span> <span class="built_in">BIGINT</span></span><br><span class="line">)<span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.base_category2'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  二级类目表</span></span><br><span class="line"><span class="comment">--   MySQL Sink</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`base_category2`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_category2`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">    <span class="string">`category1_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">     PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'base_category2'</span>, <span class="comment">-- MySQL中的待插入数据的表</span></span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'sink.buffer-flush.interval'</span> = <span class="string">'1s'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  二级类目表</span></span><br><span class="line"><span class="comment">--   MySQL Sink Load Data</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> base_category2</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> ods_base_category2;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">-- 三级类目表</span></span><br><span class="line"><span class="comment">--   kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_base_category3`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_base_category3`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`category2_id`</span> <span class="built_in">BIGINT</span></span><br><span class="line">)<span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.base_category3'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  三级类目表</span></span><br><span class="line"><span class="comment">--   MySQL Sink</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`base_category3`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`base_category3`</span> (</span><br><span class="line">    <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    <span class="string">`name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">    <span class="string">`category2_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'base_category3'</span>, <span class="comment">-- MySQL中的待插入数据的表</span></span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'sink.buffer-flush.interval'</span> = <span class="string">'1s'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--  三级类目表</span></span><br><span class="line"><span class="comment">--   MySQL Sink Load Data</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> base_category3</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> ods_base_category3;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   商品表</span></span><br><span class="line"><span class="comment">--   Kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_sku_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_sku_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`spu_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>),</span><br><span class="line">  <span class="string">`sku_name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`sku_desc`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`weight`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  <span class="string">`tm_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`category3_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`sku_default_img`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>)</span><br><span class="line">) <span class="keyword">WITH</span>(</span><br><span class="line"> <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.sku_info'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   商品表</span></span><br><span class="line"><span class="comment">--   MySQL Sink</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`sku_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`sku_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`spu_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`price`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>),</span><br><span class="line">  <span class="string">`sku_name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`sku_desc`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`weight`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  <span class="string">`tm_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`category3_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`sku_default_img`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>),</span><br><span class="line">   PRIMARY <span class="keyword">KEY</span> (tm_id) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'sku_info'</span>, <span class="comment">-- MySQL中的待插入数据的表</span></span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'sink.buffer-flush.interval'</span> = <span class="string">'1s'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   商品</span></span><br><span class="line"><span class="comment">--   MySQL Sink Load Data</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> sku_info</span><br><span class="line"><span class="keyword">SELECT</span> *</span><br><span class="line"><span class="keyword">FROM</span> ods_sku_info;</span><br></pre></td></tr></table></figure>

<p>经过上面的步骤，我们可以将创建商品维表的基础数据表同步到MySQL中，同样需要提前创建好对应的数据表。接下来我们使用上面的基础表在mySQL的dim库中创建一张视图：<code>dim_sku_info</code>，用作后续使用的维表。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- DIM层,商品维表,</span></span><br><span class="line"><span class="comment">-- 在MySQL中创建视图</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> dim_sku_info <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  si.id <span class="keyword">AS</span> <span class="keyword">id</span>,</span><br><span class="line">  si.sku_name <span class="keyword">AS</span> sku_name,</span><br><span class="line">  si.category3_id <span class="keyword">AS</span> c3_id,</span><br><span class="line">  si.weight <span class="keyword">AS</span> weight,</span><br><span class="line">  si.tm_id <span class="keyword">AS</span> tm_id,</span><br><span class="line">  si.price <span class="keyword">AS</span> price,</span><br><span class="line">  si.spu_id <span class="keyword">AS</span> spu_id,</span><br><span class="line">  c3.name <span class="keyword">AS</span> c3_name,</span><br><span class="line">  c2.id <span class="keyword">AS</span> c2_id,</span><br><span class="line">  c2.name <span class="keyword">AS</span> c2_name,</span><br><span class="line">  c3.id <span class="keyword">AS</span> c1_id,</span><br><span class="line">  c3.name <span class="keyword">AS</span> c1_name</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">(</span><br><span class="line">  sku_info si </span><br><span class="line">  <span class="keyword">JOIN</span> base_category3 c3 <span class="keyword">ON</span> si.category3_id = c3.id</span><br><span class="line">  <span class="keyword">JOIN</span> base_category2 c2 <span class="keyword">ON</span> c3.category2_id =c2.id</span><br><span class="line">  <span class="keyword">JOIN</span> base_category1 c1 <span class="keyword">ON</span> c2.category1_id = c1.id</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>至此，我们所需要的维表数据已经准备好了，接下来开始处理DWD层的数据。</p>
<h3 id="DWD层数据处理"><a href="#DWD层数据处理" class="headerlink" title="DWD层数据处理"></a>DWD层数据处理</h3><p>经过上面的步骤，我们已经将所用的维表已经准备好了。接下来我们将对ODS的原始数据进行处理，加工成DWD层的明细宽表。具体过程如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   订单详情</span></span><br><span class="line"><span class="comment">--   Kafka Source</span></span><br><span class="line"><span class="comment">-- ------------------------- </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_order_detail`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_order_detail`</span>(</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`order_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`sku_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`sku_name`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`img_url`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`order_price`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  <span class="string">`sku_num`</span> <span class="built_in">INT</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>)</span><br><span class="line">) <span class="keyword">WITH</span>(</span><br><span class="line"> <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.order_detail'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="comment">--   订单信息</span></span><br><span class="line"><span class="comment">--   Kafka Source</span></span><br><span class="line"><span class="comment">-- -------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`ods_order_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ods_order_info`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`consignee`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`consignee_tel`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`total_amount`</span> <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  <span class="string">`order_status`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`user_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`payment_way`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`delivery_address`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`order_comment`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`out_trade_no`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`trade_body`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>) ,</span><br><span class="line">  <span class="string">`operate_time`</span> <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>) ,</span><br><span class="line">  <span class="string">`expire_time`</span> <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>) ,</span><br><span class="line">  <span class="string">`tracking_no`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`parent_order_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`img_url`</span> <span class="keyword">STRING</span>,</span><br><span class="line">  <span class="string">`province_id`</span> <span class="built_in">INT</span></span><br><span class="line">) <span class="keyword">WITH</span>(</span><br><span class="line"><span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line"> <span class="string">'topic'</span> = <span class="string">'mydw.order_info'</span>,</span><br><span class="line"> <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line"> <span class="string">'properties.group.id'</span> = <span class="string">'testGroup'</span>,</span><br><span class="line"> <span class="string">'format'</span> = <span class="string">'canal-json'</span> ,</span><br><span class="line"> <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span> </span><br><span class="line">) ; </span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- DWD层,支付订单明细表dwd_paid_order_detail</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> dwd_paid_order_detail;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwd_paid_order_detail</span><br><span class="line">(</span><br><span class="line">  detail_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  order_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  user_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  province_id <span class="built_in">INT</span>,</span><br><span class="line">  sku_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  sku_name <span class="keyword">STRING</span>,</span><br><span class="line">  sku_num <span class="built_in">INT</span>,</span><br><span class="line">  order_price <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">0</span>),</span><br><span class="line">  create_time <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>),</span><br><span class="line">  pay_time <span class="built_in">TIMESTAMP</span>(<span class="number">0</span>)</span><br><span class="line"> ) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'dwd_paid_order_detail'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- DWD层,已支付订单明细表</span></span><br><span class="line"><span class="comment">-- 向dwd_paid_order_detail装载数据</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dwd_paid_order_detail</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  od.id,</span><br><span class="line">  oi.id order_id,</span><br><span class="line">  oi.user_id,</span><br><span class="line">  oi.province_id,</span><br><span class="line">  od.sku_id,</span><br><span class="line">  od.sku_name,</span><br><span class="line">  od.sku_num,</span><br><span class="line">  od.order_price,</span><br><span class="line">  oi.create_time,</span><br><span class="line">  oi.operate_time</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">SELECT</span> * </span><br><span class="line">    <span class="keyword">FROM</span> ods_order_info</span><br><span class="line">    <span class="keyword">WHERE</span> order_status = <span class="string">'2'</span> <span class="comment">-- 已支付</span></span><br><span class="line">    ) oi <span class="keyword">JOIN</span></span><br><span class="line">    (</span><br><span class="line">    <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> ods_order_detail</span><br><span class="line">    ) od </span><br><span class="line">    <span class="keyword">ON</span> oi.id = od.order_id;</span><br></pre></td></tr></table></figure>

<img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/npm\mywebsite\source\_posts\实时数仓-基于Flink1-11的SQL构建实时数仓探索实践\任务1.png">

<h3 id="ADS层数据"><a href="#ADS层数据" class="headerlink" title="ADS层数据"></a>ADS层数据</h3><p>经过上面的步骤，我们创建了一张dwd_paid_order_detail明细宽表，并将该表存储在了Kafka中。接下来我们将使用这张明细宽表与维表进行JOIN，得到我们ADS应用层数据。</p>
<ul>
<li><strong>ads_province_index</strong></li>
</ul>
<p>首先在MySQL中创建对应的ADS目标表：<strong>ads_province_index</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ads.ads_province_index(</span><br><span class="line">  province_id <span class="built_in">INT</span>(<span class="number">10</span>),</span><br><span class="line">  area_code <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  province_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  region_id <span class="built_in">INT</span>(<span class="number">10</span>),</span><br><span class="line">  region_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  order_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  order_count <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  dt <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (province_id, dt) </span><br><span class="line">) ;</span><br></pre></td></tr></table></figure>

<p>向MySQL的ADS层目标装载数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Flink SQL Cli操作</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- 使用 DDL创建MySQL中的ADS层表</span></span><br><span class="line"><span class="comment">-- 指标：1.每天每个省份的订单数</span></span><br><span class="line"><span class="comment">--      2.每天每个省份的订单金额</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ads_province_index(</span><br><span class="line">  province_id <span class="built_in">INT</span>,</span><br><span class="line">  area_code <span class="keyword">STRING</span>,</span><br><span class="line">  province_name <span class="keyword">STRING</span>,</span><br><span class="line">  region_id <span class="built_in">INT</span>,</span><br><span class="line">  region_name <span class="keyword">STRING</span>,</span><br><span class="line">  order_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  order_count <span class="built_in">BIGINT</span>,</span><br><span class="line">  dt <span class="keyword">STRING</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (province_id, dt) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span>  </span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/ads'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'ads_province_index'</span>, </span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- dwd_paid_order_detail已支付订单明细宽表</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwd_paid_order_detail</span><br><span class="line">(</span><br><span class="line">  detail_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  order_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  user_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  province_id <span class="built_in">INT</span>,</span><br><span class="line">  sku_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  sku_name <span class="keyword">STRING</span>,</span><br><span class="line">  sku_num <span class="built_in">INT</span>,</span><br><span class="line">  order_price <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  create_time <span class="keyword">STRING</span>,</span><br><span class="line">  pay_time <span class="keyword">STRING</span></span><br><span class="line"> ) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'dwd_paid_order_detail'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- tmp_province_index</span></span><br><span class="line"><span class="comment">-- 订单汇总临时表</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_province_index(</span><br><span class="line">    province_id <span class="built_in">INT</span>,</span><br><span class="line">    order_count <span class="built_in">BIGINT</span>,<span class="comment">-- 订单数</span></span><br><span class="line">    order_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>), <span class="comment">-- 订单金额</span></span><br><span class="line">    pay_date <span class="built_in">DATE</span></span><br><span class="line">)<span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'tmp_province_index'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- tmp_province_index</span></span><br><span class="line"><span class="comment">-- 订单汇总临时表数据装载</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp_province_index</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">      province_id,</span><br><span class="line">      <span class="keyword">count</span>(<span class="keyword">distinct</span> order_id) order_count,<span class="comment">-- 订单数</span></span><br><span class="line">      <span class="keyword">sum</span>(order_price * sku_num) order_amount, <span class="comment">-- 订单金额</span></span><br><span class="line">      <span class="keyword">TO_DATE</span>(pay_time,<span class="string">'yyyy-MM-dd'</span>) pay_date</span><br><span class="line"><span class="keyword">FROM</span> dwd_paid_order_detail</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> province_id,<span class="keyword">TO_DATE</span>(pay_time,<span class="string">'yyyy-MM-dd'</span>)</span><br><span class="line">;</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- tmp_province_index_source</span></span><br><span class="line"><span class="comment">-- 使用该临时汇总表，作为数据源</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_province_index_source(</span><br><span class="line">    province_id <span class="built_in">INT</span>,</span><br><span class="line">    order_count <span class="built_in">BIGINT</span>,<span class="comment">-- 订单数</span></span><br><span class="line">    order_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>), <span class="comment">-- 订单金额</span></span><br><span class="line">    pay_date <span class="built_in">DATE</span>,</span><br><span class="line">    proctime <span class="keyword">as</span> PROCTIME()   <span class="comment">-- 通过计算列产生一个处理时间列</span></span><br><span class="line"> ) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'tmp_province_index'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- DIM层,区域维表,</span></span><br><span class="line"><span class="comment">-- 创建区域维表数据源</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`dim_province`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dim_province (</span><br><span class="line">  province_id <span class="built_in">INT</span>,</span><br><span class="line">  province_name <span class="keyword">STRING</span>,</span><br><span class="line">  area_code <span class="keyword">STRING</span>,</span><br><span class="line">  region_id <span class="built_in">INT</span>,</span><br><span class="line">  region_name <span class="keyword">STRING</span> ,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (province_id) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'dim_province'</span>, </span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'scan.fetch-size'</span> = <span class="string">'100'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- 向ads_province_index装载数据</span></span><br><span class="line"><span class="comment">-- 维表JOIN</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ads_province_index</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  pc.province_id,</span><br><span class="line">  dp.area_code,</span><br><span class="line">  dp.province_name,</span><br><span class="line">  dp.region_id,</span><br><span class="line">  dp.region_name,</span><br><span class="line">  pc.order_amount,</span><br><span class="line">  pc.order_count,</span><br><span class="line">  <span class="keyword">cast</span>(pc.pay_date <span class="keyword">as</span> <span class="built_in">VARCHAR</span>)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">tmp_province_index_source pc</span><br><span class="line">  <span class="keyword">JOIN</span> dim_province <span class="keyword">FOR</span> SYSTEM_TIME <span class="keyword">AS</span> <span class="keyword">OF</span> pc.proctime <span class="keyword">as</span> dp </span><br><span class="line">  <span class="keyword">ON</span> dp.province_id = pc.province_id;</span><br></pre></td></tr></table></figure>

<p>当提交任务之后：观察Flink WEB UI：</p>
<img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/任务2.png" style="zoom:50%;">

<p>查看ADS层的ads_province_index表数据：</p>
<p><img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/%E4%BB%BB%E5%8A%A12%E7%BB%93%E6%9E%9C.png" alt></p>
<ul>
<li><strong>ads_sku_index</strong></li>
</ul>
<p>首先在MySQL中创建对应的ADS目标表：<strong>ads_sku_index</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ads_sku_index</span><br><span class="line">(</span><br><span class="line">  sku_id <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  sku_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  weight <span class="keyword">DOUBLE</span>,</span><br><span class="line">  tm_id <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  price <span class="keyword">DOUBLE</span>,</span><br><span class="line">  spu_id <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  c3_id <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  c3_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">  c2_id <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  c2_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  c1_id <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  c1_name <span class="built_in">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">  order_amount <span class="keyword">DOUBLE</span>,</span><br><span class="line">  order_count <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  sku_count <span class="built_in">BIGINT</span>(<span class="number">10</span>),</span><br><span class="line">  dt <span class="built_in">varchar</span>(<span class="number">100</span>),</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (sku_id,dt)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>向MySQL的ADS层目标装载数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- 使用 DDL创建MySQL中的ADS层表</span></span><br><span class="line"><span class="comment">-- 指标：1.每天每个商品对应的订单个数</span></span><br><span class="line"><span class="comment">--      2.每天每个商品对应的订单金额</span></span><br><span class="line"><span class="comment">--      3.每天每个商品对应的数量</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ads_sku_index</span><br><span class="line">(</span><br><span class="line">  sku_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  sku_name <span class="built_in">VARCHAR</span>,</span><br><span class="line">  weight <span class="keyword">DOUBLE</span>,</span><br><span class="line">  tm_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  price <span class="keyword">DOUBLE</span>,</span><br><span class="line">  spu_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c3_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c3_name <span class="built_in">VARCHAR</span> ,</span><br><span class="line">  c2_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c2_name <span class="built_in">VARCHAR</span>,</span><br><span class="line">  c1_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c1_name <span class="built_in">VARCHAR</span>,</span><br><span class="line">  order_amount <span class="keyword">DOUBLE</span>,</span><br><span class="line">  order_count <span class="built_in">BIGINT</span>,</span><br><span class="line">  sku_count <span class="built_in">BIGINT</span>,</span><br><span class="line">  dt <span class="built_in">varchar</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (sku_id,dt) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/ads'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'ads_sku_index'</span>, </span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- dwd_paid_order_detail已支付订单明细宽表</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dwd_paid_order_detail</span><br><span class="line">(</span><br><span class="line">  detail_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  order_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  user_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  province_id <span class="built_in">INT</span>,</span><br><span class="line">  sku_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  sku_name <span class="keyword">STRING</span>,</span><br><span class="line">  sku_num <span class="built_in">INT</span>,</span><br><span class="line">  order_price <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  create_time <span class="keyword">STRING</span>,</span><br><span class="line">  pay_time <span class="keyword">STRING</span></span><br><span class="line"> ) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'dwd_paid_order_detail'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- tmp_sku_index</span></span><br><span class="line"><span class="comment">-- 商品指标统计</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_sku_index(</span><br><span class="line">    sku_id <span class="built_in">BIGINT</span>,</span><br><span class="line">    order_count <span class="built_in">BIGINT</span>,<span class="comment">-- 订单数</span></span><br><span class="line">    order_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>), <span class="comment">-- 订单金额</span></span><br><span class="line">	order_sku_num <span class="built_in">BIGINT</span>,</span><br><span class="line">    pay_date <span class="built_in">DATE</span></span><br><span class="line">)<span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'tmp_sku_index'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- tmp_sku_index</span></span><br><span class="line"><span class="comment">-- 数据装载</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> tmp_sku_index</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">      sku_id,</span><br><span class="line">      <span class="keyword">count</span>(<span class="keyword">distinct</span> order_id) order_count,<span class="comment">-- 订单数</span></span><br><span class="line">      <span class="keyword">sum</span>(order_price * sku_num) order_amount, <span class="comment">-- 订单金额</span></span><br><span class="line">	  <span class="keyword">sum</span>(sku_num) order_sku_num,</span><br><span class="line">      <span class="keyword">TO_DATE</span>(pay_time,<span class="string">'yyyy-MM-dd'</span>) pay_date</span><br><span class="line"><span class="keyword">FROM</span> dwd_paid_order_detail</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> sku_id,<span class="keyword">TO_DATE</span>(pay_time,<span class="string">'yyyy-MM-dd'</span>)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- tmp_sku_index_source</span></span><br><span class="line"><span class="comment">-- 使用该临时汇总表，作为数据源</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tmp_sku_index_source(</span><br><span class="line">    sku_id <span class="built_in">BIGINT</span>,</span><br><span class="line">    order_count <span class="built_in">BIGINT</span>,<span class="comment">-- 订单数</span></span><br><span class="line">    order_amount <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>), <span class="comment">-- 订单金额</span></span><br><span class="line">    order_sku_num <span class="built_in">BIGINT</span>,</span><br><span class="line">    pay_date <span class="built_in">DATE</span>,</span><br><span class="line">    proctime <span class="keyword">as</span> PROCTIME()   <span class="comment">-- 通过计算列产生一个处理时间列</span></span><br><span class="line"> ) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'kafka'</span>,</span><br><span class="line">    <span class="string">'topic'</span> = <span class="string">'tmp_sku_index'</span>,</span><br><span class="line">    <span class="string">'scan.startup.mode'</span> = <span class="string">'earliest-offset'</span>,</span><br><span class="line">    <span class="string">'properties.bootstrap.servers'</span> = <span class="string">'kms-3:9092'</span>,</span><br><span class="line">    <span class="string">'format'</span> = <span class="string">'changelog-json'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- DIM层,商品维表,</span></span><br><span class="line"><span class="comment">-- 创建商品维表数据源</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`dim_sku_info`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dim_sku_info (</span><br><span class="line">  <span class="keyword">id</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  sku_name <span class="keyword">STRING</span>,</span><br><span class="line">  c3_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  weight <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  tm_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  price <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">  spu_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c3_name <span class="keyword">STRING</span>,</span><br><span class="line">  c2_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c2_name <span class="keyword">STRING</span>,</span><br><span class="line">  c1_id <span class="built_in">BIGINT</span>,</span><br><span class="line">  c1_name <span class="keyword">STRING</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>) <span class="keyword">NOT</span> <span class="keyword">ENFORCED</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">    <span class="string">'connector'</span> = <span class="string">'jdbc'</span>,</span><br><span class="line">    <span class="string">'url'</span> = <span class="string">'jdbc:mysql://kms-1:3306/dim'</span>,</span><br><span class="line">    <span class="string">'table-name'</span> = <span class="string">'dim_sku_info'</span>, </span><br><span class="line">    <span class="string">'driver'</span> = <span class="string">'com.mysql.jdbc.Driver'</span>,</span><br><span class="line">    <span class="string">'username'</span> = <span class="string">'root'</span>,</span><br><span class="line">    <span class="string">'password'</span> = <span class="string">'123qwe'</span>,</span><br><span class="line">    <span class="string">'scan.fetch-size'</span> = <span class="string">'100'</span></span><br><span class="line">);</span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="comment">-- 向ads_sku_index装载数据</span></span><br><span class="line"><span class="comment">-- 维表JOIN</span></span><br><span class="line"><span class="comment">-- ---------------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> ads_sku_index</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  sku_id ,</span><br><span class="line">  sku_name ,</span><br><span class="line">  weight ,</span><br><span class="line">  tm_id ,</span><br><span class="line">  price ,</span><br><span class="line">  spu_id ,</span><br><span class="line">  c3_id ,</span><br><span class="line">  c3_name,</span><br><span class="line">  c2_id ,</span><br><span class="line">  c2_name ,</span><br><span class="line">  c1_id ,</span><br><span class="line">  c1_name ,</span><br><span class="line">  sc.order_amount,</span><br><span class="line">  sc.order_count ,</span><br><span class="line">  sc.order_sku_num ,</span><br><span class="line">  <span class="keyword">cast</span>(sc.pay_date <span class="keyword">as</span> <span class="built_in">VARCHAR</span>)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">tmp_sku_index_source sc </span><br><span class="line">  <span class="keyword">JOIN</span> dim_sku_info <span class="keyword">FOR</span> SYSTEM_TIME <span class="keyword">AS</span> <span class="keyword">OF</span> sc.proctime <span class="keyword">as</span> ds</span><br><span class="line">  <span class="keyword">ON</span> ds.id = sc.sku_id</span><br><span class="line">  ;</span><br></pre></td></tr></table></figure>

<p>当提交任务之后：观察Flink WEB UI：</p>
<p><img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/%E4%BB%BB%E5%8A%A13.png" alt></p>
<p>查看ADS层的ads_sku_index表数据：</p>
<p><img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/%E4%BB%BB%E5%8A%A13%E7%BB%93%E6%9E%9C.png" alt></p>
<h3 id="FineBI结果展示"><a href="#FineBI结果展示" class="headerlink" title="FineBI结果展示"></a>FineBI结果展示</h3><p><img src="//jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA.png" alt></p>
<h2 id="其他注意点"><a href="#其他注意点" class="headerlink" title="其他注意点"></a>其他注意点</h2><h3 id="Flink1-11-0存在的bug"><a href="#Flink1-11-0存在的bug" class="headerlink" title="Flink1.11.0存在的bug"></a>Flink1.11.0存在的bug</h3><p>当在代码中使用Flink1.11.0版本时，如果将一个change-log的数据源insert到一个upsert sink时，会报如下异常：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ERROR] Could not execute SQL statement. Reason:</span><br><span class="line">org.apache.flink.table.api.TableException: Provided trait [BEFORE_AND_AFTER] can<span class="string">'t satisfy required trait [ONLY_UPDATE_AFTER]. This is a bug in planner, please file an issue. </span></span><br><span class="line"><span class="string">Current node is TableSourceScan(table=[[default_catalog, default_database, t_pick_order]], fields=[order_no, status])</span></span><br></pre></td></tr></table></figure>

<p>该bug目前已被修复，修复可以在Flink1.11.1中使用。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要分享了构建一个实时数仓的demo案例，通过本文可以了解实时数仓的数据处理流程，在此基础之上，对Flink SQL的CDC会有更加深刻的认识。另外，本文给出了非常详细的使用案例，你可以直接上手进行操作，在实践中探索实时数仓的构建流程。</p>
<blockquote>
<p>公众号『大数据技术与数仓』，回复『资料』领取大数据资料包</p>
</blockquote>
</div><div class="recommended_posts"><h3>相关推荐 ☟</h3><li><a href="https://jiamaoxiang.top/2020/08/19/SQL查询的执行顺序分析/" target="_blank">SQL查询的执行顺序分析</a></li><li><a href="https://jiamaoxiang.top/2020/08/18/两阶段提交-Flink端到端的EXACTLY-ONCE实现细节/" target="_blank">两阶段提交|Flink端到端的EXACTLY ONCE实现细节</a></li><li><a href="https://jiamaoxiang.top/2020/08/12/Flink1-11中的CDC-Connectors操作实践/" target="_blank">Flink1.11中的CDC Connectors操作实践</a></li><li><a href="https://jiamaoxiang.top/2020/08/07/一文搞懂HBase的基本原理/" target="_blank">内含面试|一文搞懂HBase的基本原理</a></li></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Jia MaoXiang</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/">https://jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为博主原创文章，遵循CC BY-SA 4.0版权协议，转载请附上原文出处链接和本声明</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://jiamaoxiang.top/2020/08/12/实时数仓-基于Flink1-11的SQL构建实时数仓探索实践/" data-id="ckiye96mf006zbo7qit5ie8uc" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAADM0lEQVR42u3aUW7qQBAEQO5/ad53lNh0z5onvJS/EDFrl5EyTM8+HvHxPDjWP/v79fnK7flLBzY2NvZN2M/T4+gCyTu/b/TonfavyYN78SVhY2Njb8dOSkVbSPKCl6yQrJxYsLGxsbGTctJ+Nv8UNjY2Nvb/ZJ83DO1DyWMmbGxs7O9ktyH+u6Ol2TlvydKwsbGxP56dT0U///Vb5tvY2NjYH8x+lke72nlJa0OiNpw6VGBjY2NvxG5/7ifj3lm4P4uNZl8JNjY29t7sPKBZ2UzTbvGctRwvzsfGxsbegp3cyuymZ23DeqtTNyHY2NjYN2fPykDbPOQbcda3+Fw2M8HGxsa+CTsn5e3HrOzlpPX7x8bGxt6JPRuatqWoyLcuiqWSiAobGxt7D3a7yaYNaN6x+SYpkC/GydjY2NibsvMf9/mmmTZ4ake/+XD6kZOwsbGxb8XOY6PZjpfZzSXrzIoZNjY29q7s4kf8woVnhfOqkTM2Njb297Bnof+shMzCqZXNPT/ewcbGxv4C9krMNKO2DcnSFbGxsbG3YM9i97zxmBXFfOTQDgZ+DHqxsbGxt2BfFda3r9tr5eFUUQixsbGxt2C3W2raoH+2fhJyteA/Nl9iY2Njfw27bR5mQ4JkG1C7ftSBYWNjY9+cvRK7t0Pi2fpJMzN7HxsbG3sPdntzeSHJ4/52nNCu/Mc52NjY2BuxVxZqH1BSWmYx1vqZ2NjY2Pdl5//684CmZdQBUNyo1HUbGxsb+4bsdnw7i4TaxiMPqvItPsOGBBsbG/sm7DaUSdqJ/Jy2iOZj5hePAxsbG3tTdvu6bV2SJqHd9DNrYLCxsbH3Zs92/axv02zbjPaRYWNjY+/NTsBJKcpvJS9ObRm7INPCxsbGvgl7Fs1ftTVzVorah34YJ2FjY2NvwV75nz8Lp9ptNG3TshJIYWNjY9+X3RatvCFpS05+zkojhI2Njb0ruw3iZ2OAtqTlK+R3hY2NjY3dlpb8Km04tbLBCBsbGxt7FiStT2BXYqkLChg2Njb2B7PbyyTNxvma7SaeZDhRPHpsbGzsjdj5oDdvCZIQKm9U8iFEfkVsbGzsLdj/ANzqFhHeJ9zhAAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/实时数仓/">实时数仓</a></div><div class="post-nav"><a class="pre" href="/2020/08/18/两阶段提交-Flink端到端的EXACTLY-ONCE实现细节/">两阶段提交|Flink端到端的EXACTLY ONCE实现细节</a><a class="next" href="/2020/08/12/Flink1-11中的CDC-Connectors操作实践/">Flink1.11中的CDC Connectors操作实践</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar-toc"><div class="stoc-article" id="sidebar-stoc"><strong class="stoc-title"><i class="fa fa-list-ul"> 目录</i></strong><div class="toc-nav" id="stoc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#案例简介"><span class="toc-number">1.</span> <span class="toc-text">案例简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#架构设计"><span class="toc-number">2.</span> <span class="toc-text">架构设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#业务数据准备"><span class="toc-number">3.</span> <span class="toc-text">业务数据准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据处理流程"><span class="toc-number">4.</span> <span class="toc-text">数据处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ODS层数据同步"><span class="toc-number">4.1.</span> <span class="toc-text">ODS层数据同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DIM层维表数据准备"><span class="toc-number">4.2.</span> <span class="toc-text">DIM层维表数据准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DWD层数据处理"><span class="toc-number">4.3.</span> <span class="toc-text">DWD层数据处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ADS层数据"><span class="toc-number">4.4.</span> <span class="toc-text">ADS层数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FineBI结果展示"><span class="toc-number">4.5.</span> <span class="toc-text">FineBI结果展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其他注意点"><span class="toc-number">5.</span> <span class="toc-text">其他注意点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Flink1-11-0存在的bug"><span class="toc-number">5.1.</span> <span class="toc-text">Flink1.11.0存在的bug</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 - 2020 <a href="/." rel="nofollow">Jmx's Blog.</a>All rights reserved.<br>Thoughts on technology, life and everything else.</div></div></div><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.5" zindex="0.7" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>