<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录朴实无华且枯燥的生活"><title> | Jmx's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '912b6cfc43243cd27aeb428f7dbf7823';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Jmx's Blog</h1><a id="logo" href="/.">Jmx's Blog</a><p class="description">Keep it Simple and Stupid!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-pied-piper-alt"> 关于</i></a><a href="/tags"><i class="fa fa-tags"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title"></h1><div class="post-meta">Sep 24, 2019<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 4</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><h2 id="什么是数据倾斜-怎样去处理数据倾斜"><a href="#什么是数据倾斜-怎样去处理数据倾斜" class="headerlink" title="什么是数据倾斜,怎样去处理数据倾斜"></a>什么是数据倾斜,怎样去处理数据倾斜</h2><p>数据倾斜是一种很常见的问题（依据二八定律），简单来说，比方WordCount中某个Key对应的数据量非常大的话，就会产生数据倾斜，导致两个后果：</p>
<ul>
<li>OOM（单或少数的节点）；</li>
<li>拖慢整个Job执行时间（其他已经完成的节点都在等这个还在做的节点）</li>
</ul>
<h4 id="数据倾斜主要分为两类-聚合倾斜-和-join倾斜"><a href="#数据倾斜主要分为两类-聚合倾斜-和-join倾斜" class="headerlink" title="数据倾斜主要分为两类: 聚合倾斜 和 join倾斜"></a>数据倾斜主要分为两类: 聚合倾斜 和 join倾斜</h4><ul>
<li><p><strong>聚合倾斜</strong></p>
<ul>
<li><p><strong>双重聚合（局部聚合+全局聚合）</strong></p>
<p><strong>场景</strong>: 对RDD进行reduceByKey等聚合类shuffle算子，SparkSQL的groupBy做分组聚合这两种情况<br> 思路：首先通过map给每个key打上n以内的随机数的前缀并进行局部聚合，即(hello, 1) (hello, 1) (hello, 1) (hello, 1)变为(1_hello, 1) (1_hello, 1) (2_hello, 1)，并进行reduceByKey的局部聚合，然后再次map将key的前缀随机数去掉再次进行全局聚合；<br> <strong>原理</strong>: 对原本相同的key进行随机数附加，变成不同key，让原本一个task处理的数据分摊到多个task做局部聚合，规避单task数据过量。之后再去随机前缀进行全局聚合；<br> 优点：效果非常好（对聚合类Shuffle操作的倾斜问题）；<br> 缺点：范围窄（仅适用于聚合类的Shuffle操作，join类的Shuffle还需其它方案）</p>
</li>
</ul>
</li>
<li><p><strong>join倾斜</strong></p>
<ul>
<li><p><strong>将reduce join转为map join</strong></p>
<p><strong>场景</strong>: 对RDD或Spark SQL使用join类操作或语句，且join操作的RDD或表比较小（百兆或1,2G）； 思路：使用broadcast和map类算子实现join的功能替代原本的join，彻底规避shuffle。对较小RDD直接collect到内存，并创建broadcast变量；并对另外一个RDD执行map类算子，在该算子的函数中，从broadcast变量（collect出的较小RDD）与当前RDD中的每条数据依次比对key，相同的key执行你需要方式的join；</p>
<p><strong>原理</strong>: 若RDD较小，可采用广播小的RDD，并对大的RDD进行map，来实现与join同样的效果。简而言之，用broadcast-map代替join，规避join带来的shuffle（无Shuffle无倾斜）； 优点：效果很好（对join操作导致的倾斜），根治； </p>
<p><strong>缺点</strong>：适用场景小（大表+小表），广播（driver和executor节点都会驻留小表数据）小表也耗内存</p>
</li>
<li><p><strong>采样倾斜key并分拆join操作</strong></p>
<p><strong>场景</strong>: 两个较大的（无法采用方案五）RDD/Hive表进行join时，且一个RDD/Hive表中少数key数据量过大，另一个RDD/Hive表的key分布较均匀（RDD中两者之一有一个更倾斜）；<br><strong>思路</strong>:</p>
<ol>
<li>对更倾斜rdd1进行采样（RDD.sample）并统计出数据量最大的几个key；</li>
<li>对这几个倾斜的key从原本rdd1中拆出形成一个单独的rdd1_1，并打上0~n的随机数前缀，被拆分的原rdd1的另一部分（不包含倾斜key）又形成一个新rdd1_2；</li>
<li>对rdd2过滤出rdd1倾斜的key，得到rdd2_1，并将其中每条数据扩n倍，对每条数据按顺序附加0~n的前缀，被拆分出key的rdd2也独立形成另一个rdd2_2； 【个人认为，这里扩了n倍，最后union完还需要将每个倾斜key对应的value减去(n-1)】</li>
<li>将加了随机前缀的rdd1_1和rdd2_1进行join（此时原本倾斜的key被打散n份并被分散到更多的task中进行join）； 【个人认为，这里应该做两次join，两次join中间有一个map去前缀】</li>
<li>另外两个普通的RDD（rdd1_2、rdd2_2）照常join；</li>
<li>最后将两次join的结果用union结合得到最终的join结果。 原理：对join导致的倾斜是因为某几个key，可将原本RDD中的倾斜key拆分出原RDD得到新RDD，并以加随机前缀的方式打散n份做join，将倾斜key对应的大量数据分摊到更多task上来规避倾斜；</li>
</ol>
<p><strong>优点</strong>: 前提是join导致的倾斜（某几个key倾斜），避免占用过多内存（只需对少数倾斜key扩容n倍）；<br><strong>缺点</strong>: 对过多倾斜key不适用。</p>
</li>
<li><p><strong>用随机前缀和扩容RDD进行join</strong></p>
<p><strong>场景</strong>: RDD中有大量key导致倾斜； 思路：与方案六类似。</p>
<ol>
<li>查看RDD/Hive表中数据分布并找到造成倾斜的RDD/表；</li>
<li>对倾斜RDD中的每条数据打上n以内的随机数前缀；</li>
<li>对另外一个正常RDD的每条数据扩容n倍，扩容出的每条数据依次打上0到n的前缀；</li>
<li>对处理后的两个RDD进行join。</li>
</ol>
<p><strong>原理</strong>: 与方案六只有唯一不同在于这里对不倾斜RDD中所有数据进行扩大n倍，而不是找出倾斜key进行扩容；<br><strong>优点</strong>: 对join类的数据倾斜都可处理，效果非常显著；<br><strong>缺点</strong>: 缓解，扩容需要大内存</p>
</li>
</ul>
</li>
</ul>
<p><a href="https://juejin.im/post/5ccd5cc7f265da03474e1249#heading-9" target="_blank" rel="noopener">参考文章1</a></p>
<p><a href="https://blog.csdn.net/qq_35394891/article/details/82260907" target="_blank" rel="noopener">参考文章2</a></p>
</div><div class="recommended_posts"><h3>相关推荐 ☟</h3><li><a href="https://jiamaoxiang.top/2019/09/24/docs/讲一下flinkonyarn的部署/" target="_blank"></a></li><li><a href="https://jiamaoxiang.top/2019/09/24/docs/按照学生科目取每个科目的TopN/" target="_blank"></a></li><li><a href="https://jiamaoxiang.top/2019/09/24/docs/小文件过多会有什么危害/" target="_blank"></a></li><li><a href="https://jiamaoxiang.top/2019/09/24/docs/如何通过offset寻找数据/" target="_blank"></a></li></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>Jia MaoXiang</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/09/24/docs/怎样去处理数据倾斜/">https://jiamaoxiang.top/2019/09/24/docs/怎样去处理数据倾斜/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本文为博主原创文章，遵循CC BY-SA 4.0版权协议，转载请附上原文出处链接和本声明</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://jiamaoxiang.top/2019/09/24/docs/怎样去处理数据倾斜/" data-id="ck0x5xk5v003do47qhdjctb31" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACuElEQVR42u3aQW4CMQwFUO5/aSpVXbRCQ7/tGFi8WVWFGfKCFIcf327xdf++eq9Wn/D49+/rtnHh4eHhtYZ+dT2+52q4ybCu7up9+vO78PDw8LZ5+WJ9Nbj8rmp5qI4HDw8P73N41aX/+RPyrXZSYPDw8PA+mfd8oPmCngQNeHh4eJ/MS+KA6rCSLXj+/vWsBQ8PDy/mTWKCd/29eL6Hh4eHNzhVnyy+eWnZGNvPk/Hw8PAWeNXtcq8JoBrXVp/5z6fg4eHhLfDOUk81TuUhciGGwMPDwxvz5oDnUWy+Hc9j36TA4OHh4e3xqgFub1iTw7B8E1+ugXh4eHgtXvUgvwroHfPn30kU4OLh4eEd5U02xBuRbvLMJDrBw8PD2+Mlw9o+7sqp+Xf1Z0uNh4eHd5TX+8GfL+6nqDkp6ozAw8PDG/Oq+W5ytF+9t9pe0Awj8PDw8Ma8edNA3m6VRLpV2D/lBw8PD2+Bl5eEahnIp6z6/HJZwsPDw3s5r/cxZ1sHRtEJHh4e3lFeHkAkW+0eO490q1t/PDw8vHfxJgFBs/+rte0uVzw8PDy8Fm8S5ibRbXUikqdVN/p4eHh4Z3n5kdW87anQxVBsR4i+Nzw8PLxDvPlCP1/Ke5NY/t2Ah4eHd4jXO5jvLegHlvh4Ox7lxHh4eHgtXvWIK5+O6tQkxSmfRDw8PLw9Xh7g5tvo6hDz/1cnFA8PD2+D12tpystJnogUalfcFoaHh4e3wbsXr2TRz0PhfDqabQp4eHh4C7zegpvfXN0cV7fOyTvx8PDwNni9YlAtDL2Wgl7BwMPDw3sNr9oI1RtissT3AohCyoKHh4f3cl7+/t409ZoYLl/Fw8PDeysvj3F7R2L5q4XygIeHh7fGmx96TQrMvXVFZQMPDw9vgTc/AJss/XlQmwS7vTgDDw8PL/6UL2rnQQWWmG0GAAAAAElFTkSuQmCC">分享</a><div class="tags"></div><div class="post-nav"><a class="pre" href="/2019/09/24/docs/按照学生科目取每个科目的TopN/"></a><a class="next" href="/2019/09/24/docs/小文件过多会有什么危害/"></a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Azkaban/">Azkaban</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flink/">Flink</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Impala/">Impala</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/flink/" style="font-size: 25px; color: #00cd66">flink</a> <a href="/tags/Azkaban/" style="font-size: 15px; color: #5f9ea0">Azkaban</a> <a href="/tags/Impala/" style="font-size: 15px; color: #5f9ea0">Impala</a> <a href="/tags/Spark/" style="font-size: 15px; color: #5f9ea0">Spark</a> <a href="/tags/MySQL/" style="font-size: 15px; color: #5f9ea0">MySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/flink的window分类/">flink的window分类</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/说一下zk的通知机制/">docs/说一下zk的通知机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下宽依赖和窄依赖/">docs/讲一下宽依赖和窄依赖</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下zookeeper在kafka中的作用/">docs/讲一下zookeeper在kafka中的作用</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下spark的运行架构/">docs/讲一下spark的运行架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下spark的几种部署方式/">docs/讲一下spark的几种部署方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下leader 选举过程/">docs/讲一下leader 选举过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下kafk的架构/">docs/讲一下kafk的架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下hbase读数据的流程/">docs/讲一下hbase读数据的流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/docs/讲一下hbase的存储结构/">docs/讲一下hbase的存储结构</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.csdn.net/jmx_bigdata" title="我的CSDN博客" target="_blank">我的CSDN博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 - 2019 <a href="/." rel="nofollow">Jmx's Blog.</a>All rights reserved.<br>Thoughts on technology, life and everything else.</div></div></div><script type="text/javascript" src="/js/toc.js?v=0.0.0"></script><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" color="100,99,98" opacity="0.5" zindex="0.7" count="150" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>